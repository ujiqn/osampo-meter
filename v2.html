<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>„Åä„Åï„Çì„ÅΩ„Åß„Çì„Åó„ÇÉ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üöÇ</text></svg>">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif;
    background: #F7F8FC;
    color: #2D3748;
    display: flex;
    flex-direction: column;
  }

  /* „Éò„ÉÉ„ÉÄ„Éº */
  .header {
    padding: 10px 16px;
    background: #1B365D;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    color: #fff;
  }
  .header h1 { font-size: 17px; white-space: nowrap; }
  .header-right { display: flex; align-items: center; gap: 6px; }
  .ble-badge {
    font-size: 11px; padding: 3px 8px; border-radius: 10px;
    background: rgba(255,255,255,0.15); color: #ccc; white-space: nowrap;
  }
  .ble-badge.connected { background: #38A169; color: #fff; }
  .ble-badge.test-mode { background: #D69E2E; color: #fff; }
  .btn-test-mini {
    font-size: 9px; padding: 2px 6px; border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px; background: transparent; color: #999; cursor: pointer;
  }
  .btn-test-mini.active { background: #D69E2E; border-color: #D69E2E; color: #fff; }

  /* Ê§úÁ¥¢„Éê„Éº */
  .search-bar {
    display: flex; gap: 8px; padding: 8px 12px;
    background: #fff; border-bottom: 1px solid #E2E8F0; flex-shrink: 0;
  }
  .search-bar input {
    flex: 1; padding: 8px 12px; border: 1px solid #CBD5E0; border-radius: 8px;
    background: #F7F8FC; color: #2D3748; font-size: 14px; outline: none;
  }
  .search-bar input:focus { border-color: #4299E1; }
  .search-bar input::placeholder { color: #A0AEC0; }
  .search-bar button {
    padding: 8px 14px; border: none; border-radius: 8px;
    background: #4299E1; color: #fff; font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .search-bar button:disabled { opacity: 0.4; }

  /* Ê§úÁ¥¢ÁµêÊûú */
  .search-results {
    position: absolute; top: 0; left: 0; right: 0;
    background: #fff; z-index: 3000; max-height: 100%; overflow-y: auto; display: none;
  }
  .search-results.show { display: block; }
  .sr-item { padding: 12px 16px; border-bottom: 1px solid #EDF2F7; cursor: pointer; }
  .sr-item:active { background: #EBF8FF; }
  .sr-name { font-size: 14px; color: #2D3748; }
  .sr-addr { font-size: 11px; color: #A0AEC0; margin-top: 2px; }
  .sr-close { padding: 12px; text-align: center; color: #E53E3E; cursor: pointer; font-size: 13px; }

  /* Âú∞Âõ≥ */
  #map-container { position: relative; flex: 1; min-height: 120px; }
  #map { width: 100%; height: 100%; }
  .map-hint {
    position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
    background: rgba(27,54,93,0.85); color: #fff; padding: 5px 12px;
    border-radius: 14px; font-size: 12px; pointer-events: none; z-index: 1000;
  }

  /* ÈßÖ„É™„Çπ„Éà */
  .station-panel {
    background: #fff; border-top: 1px solid #E2E8F0;
    max-height: 180px; overflow-y: auto; flex-shrink: 0;
  }
  .station-list { list-style: none; padding: 0; }
  .station-item {
    display: flex; align-items: center; gap: 0; padding: 8px 12px;
    border-bottom: 1px solid #F7FAFC; position: relative;
    cursor: grab; user-select: none; -webkit-user-select: none;
    transition: background 0.15s;
  }
  .station-item.dragging { opacity: 0.4; background: #EBF8FF; }
  .station-item.drag-over { border-top: 2px solid #4299E1; }
  .station-line {
    display: flex; flex-direction: column; align-items: center;
    width: 28px; flex-shrink: 0;
  }
  .station-line .track-top, .station-line .track-bottom {
    width: 3px; flex: 1; min-height: 8px;
  }
  .station-line .track-top { background: #38A169; }
  .station-line .track-bottom { background: #CBD5E0; }
  .station-item:first-child .station-line .track-top { background: transparent; }
  .station-item:last-child .station-line .track-bottom { background: transparent; }
  .station-dot {
    width: 14px; height: 14px; border-radius: 50%;
    border: 3px solid #38A169; background: #fff; flex-shrink: 0;
  }
  .station-item:last-child .station-dot {
    border-color: #E63946; background: #E63946; width: 16px; height: 16px;
  }
  .station-item:last-child .station-dot::after {
    content: '‚òÖ'; color: #fff; font-size: 8px;
    display: flex; align-items: center; justify-content: center;
    width: 100%; height: 100%;
  }
  .station-content { flex: 1; margin-left: 10px; min-width: 0; }
  .station-name-display {
    font-size: 14px; font-weight: 600; color: #2D3748;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .station-name-edit {
    font-size: 14px; font-weight: 600; color: #2D3748; border: none;
    border-bottom: 2px solid #4299E1; outline: none; background: transparent;
    width: 100%; padding: 0;
  }
  .station-dist { font-size: 11px; color: #A0AEC0; }
  .station-badge {
    font-size: 9px; padding: 1px 5px; border-radius: 4px;
    background: #FED7D7; color: #E63946; font-weight: 600; margin-left: 6px;
  }
  .station-delete {
    width: 24px; height: 24px; border: none; background: transparent;
    color: #CBD5E0; font-size: 16px; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; border-radius: 50%;
  }
  .station-delete:hover { color: #E53E3E; background: #FFF5F5; }
  .station-add {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    padding: 10px; color: #4299E1; font-size: 13px; font-weight: 600;
    cursor: pointer; border: 2px dashed #CBD5E0; margin: 8px 12px;
    border-radius: 8px; background: transparent;
    transition: border-color 0.2s, background 0.2s;
  }
  .station-add:active { background: #EBF8FF; border-color: #4299E1; }

  /* Ê¨°„ÅÆÈßÖ„Éê„Éä„Éº */
  .next-station-banner {
    display: none; padding: 8px 16px; background: #FFFFF0;
    border-top: 1px solid #FEFCBF; flex-shrink: 0;
    text-align: center;
  }
  .next-station-banner.show { display: block; }
  .next-station-label { font-size: 11px; color: #975A16; }
  .next-station-name { font-size: 16px; font-weight: 700; color: #744210; }
  .next-station-dist { font-size: 12px; color: #B7791F; margin-top: 2px; }

  /* „Éó„É≠„Ç∞„É¨„Çπ */
  .progress-section {
    padding: 10px 16px; background: #fff;
    border-top: 1px solid #E2E8F0; flex-shrink: 0; text-align: center;
  }
  .train-track-bar {
    width: 100%; height: 36px; margin-bottom: 4px;
  }
  .progress-number {
    font-size: 36px; font-weight: 800; color: #1B365D;
    font-variant-numeric: tabular-nums;
  }
  .progress-remaining { font-size: 11px; color: #A0AEC0; margin-top: 2px; }

  /* „Ç≥„É≥„Éà„É≠„Éº„É´ */
  .controls {
    padding: 10px 16px 14px; display: flex; gap: 10px;
    background: #fff; border-top: 1px solid #E2E8F0; flex-shrink: 0;
  }
  .btn {
    flex: 1; padding: 13px; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 700; cursor: pointer;
  }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-ble { background: #4299E1; color: #fff; }
  .btn-start { background: #38A169; color: #fff; }
  .btn-stop { background: #E53E3E; color: #fff; }
  .btn-goal { background: linear-gradient(135deg, #F6AD55, #E53E3E); color: #fff; }

  /* ÈßÖÂêçÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ */
  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    z-index: 5000; align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: #fff; border-radius: 16px; padding: 24px; width: 85%;
    max-width: 320px; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }
  .modal h3 { font-size: 16px; margin-bottom: 16px; text-align: center; }
  .modal-input {
    width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 10px;
    font-size: 18px; text-align: center; outline: none;
  }
  .modal-input:focus { border-color: #4299E1; }
  .modal-suffix { text-align: center; font-size: 18px; color: #718096; margin-top: 4px; }
  .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
  .modal-btn {
    flex: 1; padding: 12px; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 600; cursor: pointer;
  }
  .modal-cancel { background: #EDF2F7; color: #4A5568; }
  .modal-ok { background: #4299E1; color: #fff; }
</style>
</head>
<body>

<div class="header">
  <h1>üöÇ „Åä„Åï„Çì„ÅΩ„Åß„Çì„Åó„ÇÉ</h1>
  <div class="header-right">
    <span class="ble-badge" id="bleBadge">BLEÊú™Êé•Á∂ö</span>
    <button class="btn-test-mini" id="btnTest">TEST</button>
  </div>
</div>

<div class="search-bar">
  <input type="text" id="searchInput" placeholder="Â†¥ÊâÄ„ÇíÊ§úÁ¥¢..." enterkeyhint="search">
  <button id="searchBtn">Ê§úÁ¥¢</button>
</div>

<div id="map-container">
  <div class="map-hint" id="mapHint">„Çø„ÉÉ„Éó or Ê§úÁ¥¢„ÅßÈßÖ„ÇíËøΩÂä†</div>
  <div class="search-results" id="searchResults"></div>
  <div id="map"></div>
</div>

<div class="station-panel" id="stationPanel">
  <ul class="station-list" id="stationList"></ul>
  <div class="station-add" id="stationAdd">+ „Åà„Åç„Çí„Å§„ÅÑ„Åã</div>
</div>

<div class="next-station-banner" id="nextBanner">
  <div class="next-station-label">üöÉ „Å§„Åé„ÅØ</div>
  <div class="next-station-name" id="nextName">---ÈßÖ</div>
  <div class="next-station-dist" id="nextDist"></div>
</div>

<div class="progress-section">
  <canvas class="train-track-bar" id="trainCanvas" width="360" height="36"></canvas>
  <div class="progress-number"><span id="progressValue">0.000</span>%</div>
  <div class="progress-remaining" id="progressRemaining"></div>
</div>

<div class="controls">
  <button class="btn btn-ble" id="btnBle">BLEÊé•Á∂ö</button>
  <button class="btn btn-start" id="btnStart" disabled>„Åó„ÇÖ„Å£„Å±„Å§!</button>
  <button class="btn btn-goal" id="btnGoal" style="display:none;">„Ç¥„Éº„É´!</button>
</div>

<!-- ÈßÖÂêçÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
<div class="modal-overlay" id="nameModal">
  <div class="modal">
    <h3>üöâ „Åà„Åç„ÅÆ„Å™„Åæ„Åà</h3>
    <input class="modal-input" id="nameInput" placeholder="„Åì„ÅÜ„Åà„Çì" maxlength="6" autocomplete="off">
    <div class="modal-suffix">ÈßÖ</div>
    <div class="modal-buttons">
      <button class="modal-btn modal-cancel" id="nameCancel">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="modal-btn modal-ok" id="nameOk">OK</button>
    </div>
  </div>
</div>

<script>
const GMAP_API_KEY = 'AIzaSyDnmItjYjosd4qMt63vWkxY2twew-JVRnA';

function loadGoogleMaps() {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAP_API_KEY}&libraries=places&language=ja`;
    s.onload = resolve;
    s.onerror = () => reject(new Error('Google Maps Ë™≠„ÅøËæº„ÅøÂ§±Êïó'));
    document.head.appendChild(s);
  });
}

loadGoogleMaps().then(initApp).catch(err => {
  alert('Google Maps„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
});

function initApp() {
  // ==================== ÂÆöÊï∞ ====================
  const SERVICE_UUID        = '12345678-1234-1234-1234-123456789abc';
  const CHARACTERISTIC_UUID = '12345678-1234-1234-1234-123456789def';
  const STORAGE_KEY = 'osampo_v2_stations';
  const STATION_ARRIVAL_RADIUS = 30;
  const GOAL_RADIUS = 10;

  // ==================== Áä∂ÊÖã ====================
  let bleDevice = null, bleCharacteristic = null;
  let watchId = null, isRunning = false, testMode = false;
  let wakeLock = null;
  let stations = []; // [{id, name, lat, lng}]
  let stationMarkers = [];
  let routeLine = null;
  let currentMarker = null;
  let startDistance = null;
  let maxProgress = 0;
  let lastSentProgress = -1;
  let nextStationIndex = 0;
  let passedStations = [];
  let addingStationMode = false;
  let pendingStationLatLng = null;

  // ==================== DOM ====================
  const $ = id => document.getElementById(id);
  const $bleBadge = $('bleBadge'), $btnBle = $('btnBle'), $btnTest = $('btnTest');
  const $btnStart = $('btnStart'), $btnGoal = $('btnGoal');
  const $progressValue = $('progressValue'), $progressRemaining = $('progressRemaining');
  const $mapHint = $('mapHint'), $stationList = $('stationList'), $stationAdd = $('stationAdd');
  const $nextBanner = $('nextBanner'), $nextName = $('nextName'), $nextDist = $('nextDist');
  const $searchInput = $('searchInput'), $searchBtn = $('searchBtn'), $searchResults = $('searchResults');
  const $nameModal = $('nameModal'), $nameInput = $('nameInput');
  const $nameCancel = $('nameCancel'), $nameOk = $('nameOk');
  const trainCanvas = $('trainCanvas');

  // ==================== Google Map ====================
  const map = new google.maps.Map($('map'), {
    center: { lat: 35.6812, lng: 139.7671 },
    zoom: 15,
    disableDefaultUI: true,
    zoomControl: true,
    styles: [
      { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] },
      { featureType: 'transit', stylers: [{ visibility: 'off' }] }
    ]
  });

  const placesService = new google.maps.places.PlacesService(map);

  // ÁèæÂú®Âú∞
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.setCenter(loc);
      map.setZoom(16);
      if (!currentMarker) {
        currentMarker = new google.maps.Circle({
          map, center: loc, radius: 8,
          fillColor: '#4299E1', fillOpacity: 1,
          strokeColor: '#fff', strokeWeight: 2, clickable: false
        });
      }
    }, () => {}, { enableHighAccuracy: true });
  }

  // ==================== ÈßÖ„Éá„Éº„ÇøÁÆ°ÁêÜ ====================
  function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }

  function saveStations() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(stations));
  }

  function loadStations() {
    try {
      const d = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if (Array.isArray(d)) { stations = d; renderStations(); updateMap(); }
    } catch(e) {}
  }

  function addStation(name, lat, lng) {
    stations.push({ id: genId(), name, lat, lng });
    saveStations(); renderStations(); updateMap(); updateStartButton();
  }

  function removeStation(id) {
    stations = stations.filter(s => s.id !== id);
    saveStations(); renderStations(); updateMap(); updateStartButton();
  }

  function renameStation(id, newName) {
    const s = stations.find(s => s.id === id);
    if (s) { s.name = newName; saveStations(); renderStations(); }
  }

  function moveStation(fromIdx, toIdx) {
    if (toIdx < 0 || toIdx >= stations.length) return;
    const [item] = stations.splice(fromIdx, 1);
    stations.splice(toIdx, 0, item);
    saveStations(); renderStations(); updateMap();
  }

  // ==================== ÈßÖ„É™„Çπ„ÉàÊèèÁîª ====================
  let dragSrcIndex = null;

  function renderStations() {
    $stationList.innerHTML = '';
    stations.forEach((s, i) => {
      const li = document.createElement('li');
      li.className = 'station-item';
      li.draggable = true;
      li.dataset.index = i;

      const isLast = i === stations.length - 1;
      const distText = i > 0
        ? formatDist(haversineDistance(stations[i-1].lat, stations[i-1].lng, s.lat, s.lng))
        : '';

      li.innerHTML = `
        <div class="station-line">
          <div class="track-top"></div>
          <div class="station-dot"></div>
          <div class="track-bottom"></div>
        </div>
        <div class="station-content">
          <div class="station-name-display" data-id="${s.id}">${s.name}ÈßÖ${isLast ? '<span class="station-badge">ÁµÇÁùÄ</span>' : ''}</div>
          ${distText ? `<div class="station-dist">${distText}</div>` : ''}
        </div>
        <button class="station-delete" data-id="${s.id}">√ó</button>
      `;

      // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó
      li.addEventListener('dragstart', e => {
        dragSrcIndex = i;
        li.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
      });
      li.addEventListener('dragend', () => {
        li.classList.remove('dragging');
        document.querySelectorAll('.station-item').forEach(el => el.classList.remove('drag-over'));
      });
      li.addEventListener('dragover', e => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        li.classList.add('drag-over');
      });
      li.addEventListener('dragleave', () => li.classList.remove('drag-over'));
      li.addEventListener('drop', e => {
        e.preventDefault();
        li.classList.remove('drag-over');
        const toIdx = parseInt(li.dataset.index);
        if (dragSrcIndex !== null && dragSrcIndex !== toIdx) {
          moveStation(dragSrcIndex, toIdx);
        }
        dragSrcIndex = null;
      });

      // „Çø„ÉÉ„ÉÅ„Éâ„É©„ÉÉ„Ç∞
      let touchStartY = 0, touchItem = null;
      li.addEventListener('touchstart', e => {
        touchStartY = e.touches[0].clientY;
        touchItem = li;
      }, { passive: true });
      li.addEventListener('touchmove', e => {
        // „Çø„ÉÉ„ÉÅ„Éâ„É©„ÉÉ„Ç∞„ÅØÁ∞°ÊòìÂÆüË£Ö - Èï∑Êäº„Åó„Åß‰∏ä‰∏ãÁßªÂãï„Éú„Çø„É≥„ÇíÂá∫„Åô‰ª£„Çè„Çä„Å´„Ç∑„É≥„Éó„É´„Å´
      }, { passive: true });

      // ÈßÖÂêç„Çø„ÉÉ„Éó„ÅßÁ∑®ÈõÜ
      const nameEl = li.querySelector('.station-name-display');
      nameEl.addEventListener('click', () => {
        if (isRunning) return;
        const input = document.createElement('input');
        input.className = 'station-name-edit';
        input.value = s.name;
        input.maxLength = 6;
        nameEl.replaceWith(input);
        input.focus();
        input.select();
        const finish = () => {
          const val = input.value.trim();
          if (val) renameStation(s.id, val);
          else renderStations();
        };
        input.addEventListener('blur', finish);
        input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
      });

      // ÂâäÈô§„Éú„Çø„É≥
      li.querySelector('.station-delete').addEventListener('click', e => {
        e.stopPropagation();
        if (isRunning) return;
        removeStation(s.id);
      });

      $stationList.appendChild(li);
    });

    // „ÄåÁµÇÁùÄ„Äç„Éê„ÉÉ„Ç∏„ÅÆËâ≤Êõ¥Êñ∞ÔºàÊúÄÂæå„ÅÆÈßÖ„ÅÆ„Éâ„ÉÉ„Éà„Å®„É©„Ç§„É≥Ôºâ
    updateStationStyles();
  }

  function updateStationStyles() {
    const items = $stationList.querySelectorAll('.station-item');
    items.forEach((li, i) => {
      const tops = li.querySelector('.track-top');
      const bots = li.querySelector('.track-bottom');
      tops.style.background = i === 0 ? 'transparent' : '#E63946';
      bots.style.background = i === items.length - 1 ? 'transparent' : '#E63946';
    });
  }

  // ==================== Âú∞Âõ≥‰∏ä„ÅÆ„Éû„Éº„Ç´„Éº„Éª„É´„Éº„ÉàÊõ¥Êñ∞ ====================
  function updateMap() {
    // Êó¢Â≠ò„Éû„Éº„Ç´„ÉºÂâäÈô§
    stationMarkers.forEach(m => m.setMap(null));
    stationMarkers = [];
    if (routeLine) { routeLine.setMap(null); routeLine = null; }

    if (stations.length === 0) {
      $mapHint.style.display = 'block';
      return;
    }
    $mapHint.style.display = addingStationMode ? 'block' : 'none';

    // ÈßÖ„Éû„Éº„Ç´„Éº
    stations.forEach((s, i) => {
      const isLast = i === stations.length - 1;
      const marker = new google.maps.Marker({
        position: { lat: s.lat, lng: s.lng },
        map,
        label: {
          text: isLast ? '‚òÖ' : String(i + 1),
          color: isLast ? '#fff' : '#fff',
          fontSize: '11px', fontWeight: 'bold'
        },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: isLast ? 13 : 10,
          fillColor: isLast ? '#E63946' : '#38A169',
          fillOpacity: 1,
          strokeColor: '#fff', strokeWeight: 2,
        },
        title: s.name + 'ÈßÖ'
      });
      stationMarkers.push(marker);
    });

    // „É´„Éº„Éà„É©„Ç§„É≥
    if (stations.length >= 2) {
      routeLine = new google.maps.Polyline({
        path: stations.map(s => ({ lat: s.lat, lng: s.lng })),
        strokeColor: '#E63946', strokeOpacity: 0.7, strokeWeight: 4,
        geodesic: true,
        icons: [{
          icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 3 },
          offset: '0', repeat: '15px'
        }]
      });
      routeLine.setMap(map);
    }
  }

  // ==================== ÈßÖËøΩÂä†„Éï„É≠„Éº ====================
  $stationAdd.addEventListener('click', () => {
    if (isRunning) return;
    addingStationMode = true;
    $mapHint.textContent = '„Çø„ÉÉ„Éó„Åó„Å¶ÈßÖ„ÅÆÂ†¥ÊâÄ„ÇíÊ±∫„ÇÅ„Å¶„Å≠';
    $mapHint.style.display = 'block';
  });

  map.addListener('click', e => {
    if (isRunning) return;
    const lat = e.latLng.lat(), lng = e.latLng.lng();
    if (addingStationMode) {
      addingStationMode = false;
      $mapHint.style.display = 'none';
      openNameModal(lat, lng);
    } else {
      // ÈÄöÂ∏∏„Çø„ÉÉ„Éó„ÇÇÈßÖËøΩÂä†
      openNameModal(lat, lng);
    }
  });

  function openNameModal(lat, lng) {
    pendingStationLatLng = { lat, lng };
    $nameInput.value = '';
    $nameModal.classList.add('show');
    setTimeout(() => $nameInput.focus(), 100);
  }

  $nameCancel.addEventListener('click', () => {
    $nameModal.classList.remove('show');
    pendingStationLatLng = null;
  });

  $nameOk.addEventListener('click', confirmStationName);
  $nameInput.addEventListener('keydown', e => { if (e.key === 'Enter') confirmStationName(); });

  function confirmStationName() {
    const name = $nameInput.value.trim();
    if (!name || !pendingStationLatLng) return;
    addStation(name, pendingStationLatLng.lat, pendingStationLatLng.lng);
    $nameModal.classList.remove('show');
    pendingStationLatLng = null;
  }

  // ==================== Ê§úÁ¥¢ ====================
  $searchBtn.addEventListener('click', doSearch);
  $searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });

  function doSearch() {
    const q = $searchInput.value.trim();
    if (!q) return;
    $searchBtn.disabled = true;
    placesService.textSearch({ query: q, language: 'ja', region: 'jp' }, (results, status) => {
      $searchBtn.disabled = false;
      $searchResults.innerHTML = '';
      if (status === google.maps.places.PlacesServiceStatus.OK && results.length) {
        results.slice(0, 5).forEach(r => {
          const item = document.createElement('div');
          item.className = 'sr-item';
          item.innerHTML = `<div class="sr-name">${r.name}</div><div class="sr-addr">${r.formatted_address || ''}</div>`;
          item.addEventListener('click', () => {
            const lat = r.geometry.location.lat(), lng = r.geometry.location.lng();
            map.setCenter({ lat, lng }); map.setZoom(16);
            $searchResults.classList.remove('show');
            $searchInput.value = r.name;
            $searchInput.blur();
            openNameModal(lat, lng);
            // ÂêçÂâç„Çí„Éó„É™„Éï„Ç£„É´
            setTimeout(() => { $nameInput.value = r.name.slice(0, 6); }, 100);
          });
          $searchResults.appendChild(item);
        });
      } else {
        $searchResults.innerHTML = '<div class="sr-item"><div class="sr-name">Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div></div>';
      }
      const close = document.createElement('div');
      close.className = 'sr-close';
      close.textContent = '√ó Èñâ„Åò„Çã';
      close.addEventListener('click', () => $searchResults.classList.remove('show'));
      $searchResults.appendChild(close);
      $searchResults.classList.add('show');
    });
  }

  // ==================== BLE ====================
  $btnBle.addEventListener('click', async () => {
    try {
      $btnBle.textContent = 'Êé•Á∂ö‰∏≠...';
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'OsampoMeter' }],
        optionalServices: [SERVICE_UUID]
      });
      bleDevice.addEventListener('gattserverdisconnected', onBleDisconnected);
      const server = await bleDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
      $bleBadge.textContent = 'BLEÊé•Á∂öÊ∏à';
      $bleBadge.classList.add('connected');
      $btnBle.textContent = 'Êé•Á∂öÊ∏à';
      $btnBle.disabled = true;
    } catch(err) {
      console.error('BLE:', err);
      $btnBle.textContent = 'BLEÊé•Á∂ö';
      alert('BLEÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  });

  function onBleDisconnected() {
    bleCharacteristic = null;
    $bleBadge.textContent = 'BLEÂàáÊñ≠';
    $bleBadge.classList.remove('connected');
    $btnBle.textContent = 'BLEÊé•Á∂ö'; $btnBle.disabled = false;
    if (isRunning) stopTracking();
  }

  // ==================== BLEÈÄÅ‰ø° (v2„Éó„É≠„Éà„Ç≥„É´) ====================
  async function sendStationNames() {
    if (!bleCharacteristic) return;
    try {
      // „ÇØ„É™„Ç¢„Ç≥„Éû„É≥„Éâ
      const clearBuf = new Uint8Array([0x02]);
      await bleCharacteristic.writeValueWithResponse(clearBuf.buffer);
      await sleep(50);

      // ÂêÑÈßÖÂêç„ÇíÈÄÅ‰ø°
      for (let i = 0; i < stations.length; i++) {
        const nameBytes = new TextEncoder().encode(stations[i].name + 'ÈßÖ');
        const pkt = new Uint8Array(3 + Math.min(nameBytes.length, 18));
        pkt[0] = 0x01; // ÈßÖÂêç„Ç≥„Éû„É≥„Éâ
        pkt[1] = i;
        pkt[2] = Math.min(nameBytes.length, 18);
        pkt.set(nameBytes.slice(0, 18), 3);
        await bleCharacteristic.writeValueWithResponse(pkt.buffer);
        await sleep(50);
      }
    } catch(err) {
      console.error('ÈßÖÂêçÈÄÅ‰ø°„Ç®„É©„Éº:', err);
    }
  }

  async function sendProgressV2(overallProgress, distNext, distFinal, nextIdx, totalSt) {
    const clamped = Math.max(0, Math.min(100000, Math.round(overallProgress)));
    if (clamped === lastSentProgress) return;
    lastSentProgress = clamped;
    if (!bleCharacteristic) return;
    try {
      const buf = new ArrayBuffer(16);
      const v = new DataView(buf);
      v.setUint8(0, 0x00); // ÈÄ≤Êçó„Ç≥„Éû„É≥„Éâ
      v.setUint32(1, clamped, true);
      v.setUint32(5, Math.max(0, Math.round(distNext)), true);
      v.setUint32(9, Math.max(0, Math.round(distFinal)), true);
      v.setUint8(13, nextIdx);
      v.setUint8(14, totalSt);
      v.setUint8(15, 0); // reserved
      await bleCharacteristic.writeValueWithoutResponse(buf);
    } catch(err) {
      console.error('BLEÈÄÅ‰ø°„Ç®„É©„Éº:', err);
    }
  }

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  // ==================== GPSËøΩË∑° ====================
  $btnStart.addEventListener('click', () => {
    if (isRunning) stopTracking(); else startTracking();
  });

  async function startTracking() {
    if (stations.length === 0) return;
    isRunning = true;
    startDistance = null;
    maxProgress = 0;
    lastSentProgress = -1;
    nextStationIndex = 0;
    passedStations = new Array(stations.length).fill(false);

    $btnStart.textContent = '„Çπ„Éà„ÉÉ„Éó';
    $btnStart.classList.remove('btn-start'); $btnStart.classList.add('btn-stop');
    $btnGoal.style.display = 'block';
    $nextBanner.classList.add('show');
    $nextName.textContent = stations[0].name + 'ÈßÖ';
    $progressValue.textContent = '0.000';
    $progressRemaining.textContent = '';
    drawTrainBar(0, 0, stations.length);

    await requestWakeLock();
    await sendStationNames();
    sendProgressV2(0, 0, 0, 0, stations.length);

    watchId = navigator.geolocation.watchPosition(
      onPositionUpdate, err => console.error('GPS:', err),
      { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
    );
  }

  function stopTracking() {
    isRunning = false;
    if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
    startDistance = null; maxProgress = 0;
    $btnStart.textContent = '„Åó„ÇÖ„Å£„Å±„Å§!';
    $btnStart.classList.remove('btn-stop'); $btnStart.classList.add('btn-start');
    $btnGoal.style.display = 'none';
    $nextBanner.classList.remove('show');
    releaseWakeLock();
  }

  function onPositionUpdate(pos) {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;

    // ÁèæÂú®Âú∞„Éû„Éº„Ç´„ÉºÊõ¥Êñ∞
    if (currentMarker) currentMarker.setCenter({ lat, lng });
    else {
      currentMarker = new google.maps.Circle({
        map, center: { lat, lng }, radius: 8,
        fillColor: '#4299E1', fillOpacity: 1,
        strokeColor: '#fff', strokeWeight: 2, clickable: false
      });
    }

    const finalStation = stations[stations.length - 1];
    const distToFinal = haversineDistance(lat, lng, finalStation.lat, finalStation.lng);

    // Âá∫Áô∫ÊôÇ„ÅÆË∑ùÈõ¢Ë®òÈå≤
    if (startDistance === null) {
      startDistance = distToFinal;
      if (startDistance < GOAL_RADIUS) startDistance = GOAL_RADIUS;
    }

    // ÈßÖÈÄöÈÅé„ÉÅ„Çß„ÉÉ„ÇØ
    for (let i = nextStationIndex; i < stations.length; i++) {
      const d = haversineDistance(lat, lng, stations[i].lat, stations[i].lng);
      const radius = (i === stations.length - 1) ? GOAL_RADIUS : STATION_ARRIVAL_RADIUS;
      if (d <= radius && !passedStations[i]) {
        passedStations[i] = true;
        if (i === nextStationIndex) {
          nextStationIndex = Math.min(i + 1, stations.length - 1);
        }
      }
    }

    // Ê¨°„ÅÆÈßÖÊÉÖÂ†±
    const nextSt = stations[Math.min(nextStationIndex, stations.length - 1)];
    const distToNext = haversineDistance(lat, lng, nextSt.lat, nextSt.lng);
    $nextName.textContent = nextSt.name + 'ÈßÖ';
    $nextDist.textContent = '„ÅÆ„Åì„Çä ' + formatDist(distToNext);

    // ÂÖ®‰ΩìÈÄ≤Êçó
    let progress;
    if (distToFinal <= GOAL_RADIUS) {
      progress = 100000;
    } else {
      progress = (1 - distToFinal / startDistance) * 100000;
      progress = Math.max(0, Math.min(99999, progress));
    }
    let progressRounded = Math.round(progress);
    if (progressRounded < maxProgress) progressRounded = maxProgress;
    else maxProgress = progressRounded;

    // UIÊõ¥Êñ∞
    $progressValue.textContent = (progressRounded / 1000).toFixed(3);
    $progressRemaining.textContent = '„Ç¥„Éº„É´„Åæ„Åß ' + formatDist(distToFinal);
    drawTrainBar(progressRounded, nextStationIndex, stations.length);

    // BLEÈÄÅ‰ø°
    sendProgressV2(progressRounded, distToNext, distToFinal, nextStationIndex, stations.length);
  }

  // ==================== Âº∑Âà∂„Ç¥„Éº„É´ ====================
  $btnGoal.addEventListener('click', () => {
    if (!isRunning) return;
    maxProgress = 100000;
    $progressValue.textContent = '100.000';
    $progressRemaining.textContent = '„Ç¥„Éº„É´!';
    $nextDist.textContent = '„Å®„ÅÜ„Å°„ÇÉ„Åè!';
    drawTrainBar(100000, stations.length, stations.length);
    sendProgressV2(100000, 0, 0, stations.length - 1, stations.length);
    stopTracking();
  });

  // ==================== „ÉÜ„Çπ„Éà„É¢„Éº„Éâ ====================
  let testTimer = null, testProgress = 0;

  $btnTest.addEventListener('click', () => {
    if (testMode) {
      testMode = false;
      if (testTimer) { clearInterval(testTimer); testTimer = null; }
      testProgress = 0;
      $btnTest.classList.remove('active');
      $bleBadge.textContent = bleCharacteristic ? 'BLEÊé•Á∂öÊ∏à' : 'BLEÊú™Êé•Á∂ö';
      $bleBadge.classList.remove('test-mode');
      $progressValue.textContent = '0.000';
      $progressRemaining.textContent = '';
      $nextBanner.classList.remove('show');
      drawTrainBar(0, 0, Math.max(1, stations.length));
      releaseWakeLock();
    } else {
      testMode = true;
      testProgress = 0;
      $btnTest.classList.add('active');
      $bleBadge.textContent = '„ÉÜ„Çπ„Éà';
      $bleBadge.classList.add('test-mode');
      $nextBanner.classList.add('show');
      requestWakeLock();

      // ÈßÖÂêçÈÄÅ‰ø°
      sendStationNames();

      const total = Math.max(1, stations.length);
      testTimer = setInterval(() => {
        testProgress += 167;
        if (testProgress > 100000) testProgress = 100000;
        const fakeSt = Math.floor((testProgress / 100000) * total);
        $progressValue.textContent = (testProgress / 1000).toFixed(3);
        $progressRemaining.textContent = '„ÉÜ„Çπ„Éà‰∏≠...';
        if (stations.length > 0) {
          const idx = Math.min(fakeSt, stations.length - 1);
          $nextName.textContent = stations[idx].name + 'ÈßÖ';
          $nextDist.textContent = '„ÉÜ„Çπ„Éà‰∏≠...';
        }
        drawTrainBar(testProgress, fakeSt, total);
        sendProgressV2(testProgress, 100, 500, Math.min(fakeSt, total - 1), total);
        if (testProgress >= 100000) { clearInterval(testTimer); testTimer = null; }
      }, 100);
    }
  });

  // ==================== ÈõªËªä„Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÊèèÁîª ====================
  function drawTrainBar(progress, nextIdx, totalStations) {
    const canvas = trainCanvas;
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.clientWidth, H = canvas.clientHeight;
    canvas.width = W * dpr; canvas.height = H * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);

    const padX = 16, trackY = H / 2 + 2;
    const trackW = W - 2 * padX;

    // ÊûïÊú®
    ctx.strokeStyle = '#E2E8F0';
    ctx.lineWidth = 1;
    for (let x = padX; x <= padX + trackW; x += 8) {
      ctx.beginPath();
      ctx.moveTo(x, trackY - 4); ctx.lineTo(x, trackY + 4);
      ctx.stroke();
    }

    // „É¨„Éº„É´
    ctx.strokeStyle = '#A0AEC0';
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(padX, trackY - 2.5); ctx.lineTo(padX + trackW, trackY - 2.5); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(padX, trackY + 2.5); ctx.lineTo(padX + trackW, trackY + 2.5); ctx.stroke();

    // ÈßÖ„Éû„Éº„Ç´„Éº
    for (let i = 0; i < totalStations; i++) {
      const x = padX + (trackW * (i + 1)) / (totalStations + 1);
      const isLast = i === totalStations - 1;
      ctx.beginPath();
      ctx.arc(x, trackY, isLast ? 5.5 : 4.5, 0, Math.PI * 2);
      if (i < nextIdx) {
        ctx.fillStyle = '#38A169'; ctx.fill();
      } else if (isLast) {
        ctx.fillStyle = '#E63946'; ctx.fill();
      } else {
        ctx.fillStyle = '#fff'; ctx.fill();
        ctx.strokeStyle = '#A0AEC0'; ctx.lineWidth = 1.5; ctx.stroke();
      }
    }

    // ÈõªËªä„Ç¢„Ç§„Ç≥„É≥
    const trainX = padX + (trackW * Math.min(progress, 100000)) / 100000;
    // Ëªä‰Ωì
    ctx.fillStyle = '#E63946';
    const bw = 14, bh = 9;
    ctx.beginPath();
    ctx.roundRect(trainX - bw/2, trackY - bh - 4, bw, bh, 2);
    ctx.fill();
    // Á™ì
    ctx.fillStyle = '#FFF5F5';
    ctx.fillRect(trainX - 4, trackY - bh - 2, 3, 3);
    ctx.fillRect(trainX + 1, trackY - bh - 2, 3, 3);
    // ÂâçÈù¢„É©„Ç§„É≥
    ctx.fillStyle = '#fff';
    ctx.fillRect(trainX - bw/2, trackY - 5, bw, 1.5);
  }

  // ==================== Wake Lock ====================
  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
      }
    } catch(e) {}
  }
  function releaseWakeLock() {
    if (wakeLock) { wakeLock.release(); wakeLock = null; }
  }
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && (isRunning || testMode)) requestWakeLock();
  });

  // ==================== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ====================
  function haversineDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000, toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function formatDist(m) {
    return m >= 1000 ? (m/1000).toFixed(1) + ' km' : Math.round(m) + ' m';
  }

  function updateStartButton() {
    $btnStart.disabled = stations.length === 0;
  }

  // ==================== ÂàùÊúüÂåñ ====================
  loadStations();
  updateStartButton();
  drawTrainBar(0, 0, Math.max(1, stations.length));
}
</script>
</body>
</html>
