<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ãŠã•ã‚“ã½ã§ã‚“ã—ã‚ƒ</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš‚</text></svg>">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif;
    background: #F7F8FC;
    color: #2D3748;
    display: flex;
    flex-direction: column;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header {
    padding: 10px 16px;
    background: #1B365D;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
    color: #fff;
  }
  .header h1 { font-size: 17px; white-space: nowrap; }
  .header-right { display: flex; align-items: center; gap: 6px; }
  .ble-badge {
    font-size: 11px; padding: 3px 8px; border-radius: 10px;
    background: rgba(255,255,255,0.15); color: #ccc; white-space: nowrap;
  }
  .ble-badge.connected { background: #38A169; color: #fff; }
  .ble-badge.test-mode { background: #D69E2E; color: #fff; }
  .btn-test-mini {
    font-size: 9px; padding: 2px 6px; border: 1px solid rgba(255,255,255,0.3);
    border-radius: 6px; background: transparent; color: #999; cursor: pointer;
  }
  .btn-test-mini.active { background: #D69E2E; border-color: #D69E2E; color: #fff; }

  /* æ¤œç´¢ãƒãƒ¼ï¼ˆé§…è¿½åŠ æ™‚ã®ã¿è¡¨ç¤ºï¼‰ */
  .search-bar {
    display: none; gap: 8px; padding: 8px 12px;
    background: #fff; border-bottom: 1px solid #E2E8F0; flex-shrink: 0;
  }
  .search-bar.show { display: flex; }
  .search-bar input {
    flex: 1; padding: 8px 12px; border: 1px solid #CBD5E0; border-radius: 8px;
    background: #F7F8FC; color: #2D3748; font-size: 14px; outline: none;
  }
  .search-bar input:focus { border-color: #4299E1; }
  .search-bar input::placeholder { color: #A0AEC0; }
  .search-bar button {
    padding: 8px 14px; border: none; border-radius: 8px;
    background: #4299E1; color: #fff; font-size: 13px; font-weight: 600; cursor: pointer;
  }
  .search-bar button:disabled { opacity: 0.4; }
  .search-bar .search-close {
    padding: 8px 10px; border: none; border-radius: 8px;
    background: #EDF2F7; color: #718096; font-size: 13px; cursor: pointer;
  }

  /* æ¤œç´¢çµæœ */
  .search-results {
    position: absolute; top: 0; left: 0; right: 0;
    background: #fff; z-index: 3000; max-height: 100%; overflow-y: auto; display: none;
  }
  .search-results.show { display: block; }
  .sr-item { padding: 12px 16px; border-bottom: 1px solid #EDF2F7; cursor: pointer; }
  .sr-item:active { background: #EBF8FF; }
  .sr-name { font-size: 14px; color: #2D3748; }
  .sr-addr { font-size: 11px; color: #A0AEC0; margin-top: 2px; }
  .sr-close { padding: 12px; text-align: center; color: #E53E3E; cursor: pointer; font-size: 13px; }

  /* åœ°å›³ */
  #map-container { position: relative; flex: 1; min-height: 120px; }
  #map { width: 100%; height: 100%; }
  .map-hint {
    position: absolute; top: 8px; left: 50%; transform: translateX(-50%);
    background: rgba(27,54,93,0.85); color: #fff; padding: 5px 12px;
    border-radius: 14px; font-size: 12px; pointer-events: none; z-index: 1000;
    display: none;
  }

  /* é§…ãƒªã‚¹ãƒˆï¼ˆè¨­å®šãƒ¢ãƒ¼ãƒ‰ï¼‰ */
  .station-panel {
    background: #fff; border-top: 1px solid #E2E8F0;
    max-height: 200px; overflow-y: auto; flex-shrink: 0;
  }
  .station-panel.hidden { display: none; }
  .station-list { list-style: none; padding: 0; }
  .station-item {
    display: flex; align-items: center; gap: 0; padding: 6px 12px;
    border-bottom: 1px solid #F7FAFC; position: relative;
    user-select: none; -webkit-user-select: none;
    transition: background 0.15s;
  }
  .station-line {
    display: flex; flex-direction: column; align-items: center;
    width: 28px; flex-shrink: 0;
  }
  .station-line .track-top, .station-line .track-bottom {
    width: 3px; flex: 1; min-height: 8px;
  }
  .station-dot {
    width: 14px; height: 14px; border-radius: 50%;
    border: 3px solid #38A169; background: #fff; flex-shrink: 0;
  }
  .station-item:last-child .station-dot {
    border-color: #E63946; background: #E63946; width: 16px; height: 16px;
  }
  .station-item:last-child .station-dot::after {
    content: 'â˜…'; color: #fff; font-size: 8px;
    display: flex; align-items: center; justify-content: center;
    width: 100%; height: 100%;
  }
  .station-content { flex: 1; margin-left: 8px; min-width: 0; }
  .station-name-display {
    font-size: 14px; font-weight: 600; color: #2D3748;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .station-name-edit {
    font-size: 14px; font-weight: 600; color: #2D3748; border: none;
    border-bottom: 2px solid #4299E1; outline: none; background: transparent;
    width: 100%; padding: 0;
  }
  .station-dist { font-size: 11px; color: #A0AEC0; }
  .station-badge {
    font-size: 9px; padding: 1px 5px; border-radius: 4px;
    background: #FED7D7; color: #E63946; font-weight: 600; margin-left: 6px;
  }
  /* ä¸¦ã¹æ›¿ãˆãƒœã‚¿ãƒ³ */
  .station-reorder {
    display: flex; flex-direction: column; gap: 2px; flex-shrink: 0; margin-right: 6px;
  }
  .station-reorder button {
    width: 32px; height: 28px; border: 1px solid #CBD5E0; background: #fff;
    color: #4A5568; font-size: 14px; cursor: pointer; border-radius: 6px;
    display: flex; align-items: center; justify-content: center; padding: 0;
    -webkit-tap-highlight-color: rgba(66,153,225,0.3);
  }
  .station-reorder button:active { background: #4299E1; color: #fff; border-color: #4299E1; }
  .station-reorder button:disabled { opacity: 0.15; cursor: not-allowed; }
  .station-delete {
    width: 24px; height: 24px; border: none; background: transparent;
    color: #CBD5E0; font-size: 16px; cursor: pointer; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; border-radius: 50%;
  }
  .station-delete:hover { color: #E53E3E; background: #FFF5F5; }
  .station-add {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    padding: 10px; color: #4299E1; font-size: 13px; font-weight: 600;
    cursor: pointer; border: 2px dashed #CBD5E0; margin: 8px 12px;
    border-radius: 8px; background: transparent;
    transition: border-color 0.2s, background 0.2s;
  }
  .station-add:active { background: #EBF8FF; border-color: #4299E1; }

  /* ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆé§…0å€‹æ™‚ï¼‰ */
  .onboarding {
    padding: 24px 20px; text-align: center;
  }
  .onboarding-icon { font-size: 40px; margin-bottom: 8px; }
  .onboarding-title { font-size: 16px; font-weight: 700; color: #1B365D; margin-bottom: 6px; }
  .onboarding-desc { font-size: 13px; color: #718096; line-height: 1.5; }
  .onboarding-btn {
    margin-top: 14px; padding: 12px 24px; border: none; border-radius: 12px;
    background: #4299E1; color: #fff; font-size: 15px; font-weight: 700;
    cursor: pointer;
  }
  .onboarding-btn:active { background: #3182CE; }

  /* æ¬¡ã®é§…ãƒãƒŠãƒ¼ï¼ˆèµ°è¡Œãƒ¢ãƒ¼ãƒ‰ï¼‰ */
  .next-station-banner {
    display: none; padding: 10px 16px; background: #FFFFF0;
    border-top: 1px solid #FEFCBF; flex-shrink: 0;
    text-align: center;
  }
  .next-station-banner.show { display: block; }
  .next-station-label { font-size: 12px; color: #975A16; }
  .next-station-name { font-size: 20px; font-weight: 700; color: #744210; }
  .next-station-dist { font-size: 13px; color: #B7791F; margin-top: 2px; }

  /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ */
  .progress-section {
    padding: 10px 16px; background: #fff;
    border-top: 1px solid #E2E8F0; flex-shrink: 0; text-align: center;
  }
  .progress-section.running-mode .train-track-bar { height: 54px; }
  .progress-section.running-mode .progress-number { font-size: 48px; }
  .train-track-bar {
    width: 100%; height: 36px; margin-bottom: 4px;
    transition: height 0.3s;
  }
  .progress-number {
    font-size: 36px; font-weight: 800; color: #1B365D;
    font-variant-numeric: tabular-nums;
    transition: font-size 0.3s;
  }
  .progress-remaining { font-size: 11px; color: #A0AEC0; margin-top: 2px; }

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
  .controls {
    padding: 10px 16px 14px; display: flex; gap: 10px;
    background: #fff; border-top: 1px solid #E2E8F0; flex-shrink: 0;
  }
  .btn {
    flex: 1; padding: 13px; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 700; cursor: pointer;
  }
  .btn:disabled { opacity: 0.35; cursor: not-allowed; }
  .btn-ble { background: #4299E1; color: #fff; }
  .btn-start { background: #38A169; color: #fff; }
  .btn-stop { background: #E53E3E; color: #fff; }
  .btn-goal { background: linear-gradient(135deg, #F6AD55, #E53E3E); color: #fff; }

  /* é§…åå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    z-index: 5000; align-items: center; justify-content: center;
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: #fff; border-radius: 16px; padding: 24px; width: 85%;
    max-width: 320px; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }
  .modal h3 { font-size: 16px; margin-bottom: 16px; text-align: center; }
  .modal-input {
    width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 10px;
    font-size: 18px; text-align: center; outline: none;
  }
  .modal-input:focus { border-color: #4299E1; }
  .modal-suffix { text-align: center; font-size: 18px; color: #718096; margin-top: 4px; }
  .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
  .modal-btn {
    flex: 1; padding: 12px; border: none; border-radius: 10px;
    font-size: 15px; font-weight: 600; cursor: pointer;
  }
  .modal-cancel { background: #EDF2F7; color: #4A5568; }
  .modal-ok { background: #4299E1; color: #fff; }
</style>
</head>
<body>

<div class="header">
  <h1>ğŸš‚ ãŠã•ã‚“ã½ã§ã‚“ã—ã‚ƒ</h1>
  <div class="header-right">
    <span class="ble-badge" id="bleBadge">BLEæœªæ¥ç¶š</span>
    <button class="btn-test-mini" id="btnTest">TEST</button>
  </div>
</div>

<div class="search-bar" id="searchBar">
  <input type="text" id="searchInput" placeholder="å ´æ‰€ã‚’æ¤œç´¢..." enterkeyhint="search">
  <button id="searchBtn">æ¤œç´¢</button>
  <button class="search-close" id="searchClose">âœ•</button>
</div>

<div id="map-container">
  <div class="map-hint" id="mapHint"></div>
  <div class="search-results" id="searchResults"></div>
  <div id="map"></div>
</div>

<div class="station-panel" id="stationPanel">
  <ul class="station-list" id="stationList"></ul>
  <div id="stationPanelBottom"></div>
</div>

<div class="next-station-banner" id="nextBanner">
  <div class="next-station-label">ğŸšƒ ã¤ãã¯</div>
  <div class="next-station-name" id="nextName">---é§…</div>
  <div class="next-station-dist" id="nextDist"></div>
</div>

<div class="progress-section" id="progressSection">
  <canvas class="train-track-bar" id="trainCanvas" width="360" height="36"></canvas>
  <div class="progress-number"><span id="progressValue">0.000</span>%</div>
  <div class="progress-remaining" id="progressRemaining"></div>
</div>

<div class="controls">
  <button class="btn btn-ble" id="btnBle">BLEæ¥ç¶š</button>
  <button class="btn btn-start" id="btnStart" disabled>ã—ã‚…ã£ã±ã¤!</button>
  <button class="btn btn-goal" id="btnGoal" style="display:none;">ã‚´ãƒ¼ãƒ«!</button>
</div>

<!-- é§…åå…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="nameModal">
  <div class="modal">
    <h3>ğŸš‰ ãˆãã®ãªã¾ãˆ</h3>
    <input class="modal-input" id="nameInput" placeholder="ã“ã†ãˆã‚“" maxlength="6" autocomplete="off">
    <div class="modal-suffix">é§…</div>
    <div class="modal-buttons">
      <button class="modal-btn modal-cancel" id="nameCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="modal-btn modal-ok" id="nameOk">OK</button>
    </div>
  </div>
</div>

<script>
const GMAP_API_KEY = 'AIzaSyDnmItjYjosd4qMt63vWkxY2twew-JVRnA';

function loadGoogleMaps() {
  return new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${GMAP_API_KEY}&libraries=places&language=ja`;
    s.onload = resolve;
    s.onerror = () => reject(new Error('Google Maps èª­ã¿è¾¼ã¿å¤±æ•—'));
    document.head.appendChild(s);
  });
}

loadGoogleMaps().then(initApp).catch(err => {
  alert('Google Mapsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
});

function initApp() {
  // ==================== å®šæ•° ====================
  const SERVICE_UUID        = '12345678-1234-1234-1234-123456789abc';
  const CHARACTERISTIC_UUID = '12345678-1234-1234-1234-123456789def';
  const STORAGE_KEY = 'osampo_v2_stations';
  const STATION_ARRIVAL_RADIUS = 30;
  const GOAL_RADIUS = 10;

  // ==================== çŠ¶æ…‹ ====================
  let bleDevice = null, bleCharacteristic = null;
  let watchId = null, isRunning = false, testMode = false;
  let wakeLock = null;
  let stations = []; // [{id, name, lat, lng}]
  let stationMarkers = [];
  let routeLine = null;
  let currentMarker = null;
  let startDistance = null;
  let maxProgress = 0;
  let lastSentProgress = -1;
  let nextStationIndex = 0;
  let passedStations = [];
  let pendingStationLatLng = null;

  // ==================== DOM ====================
  const $ = id => document.getElementById(id);
  const $bleBadge = $('bleBadge'), $btnBle = $('btnBle'), $btnTest = $('btnTest');
  const $btnStart = $('btnStart'), $btnGoal = $('btnGoal');
  const $progressValue = $('progressValue'), $progressRemaining = $('progressRemaining');
  const $progressSection = $('progressSection');
  const $mapHint = $('mapHint'), $stationList = $('stationList');
  const $stationPanel = $('stationPanel'), $stationPanelBottom = $('stationPanelBottom');
  const $nextBanner = $('nextBanner'), $nextName = $('nextName'), $nextDist = $('nextDist');
  const $searchBar = $('searchBar');
  const $searchInput = $('searchInput'), $searchBtn = $('searchBtn'), $searchResults = $('searchResults');
  const $searchClose = $('searchClose');
  const $nameModal = $('nameModal'), $nameInput = $('nameInput');
  const $nameCancel = $('nameCancel'), $nameOk = $('nameOk');
  const trainCanvas = $('trainCanvas');

  // ==================== Google Map ====================
  const map = new google.maps.Map($('map'), {
    center: { lat: 35.6812, lng: 139.7671 },
    zoom: 15,
    disableDefaultUI: true,
    zoomControl: true,
    styles: [
      { featureType: 'poi', elementType: 'labels', stylers: [{ visibility: 'off' }] },
      { featureType: 'transit', stylers: [{ visibility: 'off' }] }
    ]
  });

  const placesService = new google.maps.places.PlacesService(map);

  // ç¾åœ¨åœ°
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      map.setCenter(loc);
      map.setZoom(16);
      if (!currentMarker) {
        currentMarker = new google.maps.Circle({
          map, center: loc, radius: 8,
          fillColor: '#4299E1', fillOpacity: 1,
          strokeColor: '#fff', strokeWeight: 2, clickable: false
        });
      }
    }, () => {}, { enableHighAccuracy: true });
  }

  // ==================== ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ====================
  function enterRunningMode() {
    $stationPanel.classList.add('hidden');
    $searchBar.classList.remove('show');
    $nextBanner.classList.add('show');
    $progressSection.classList.add('running-mode');
    // Canvasé«˜ã•æ›´æ–°
    setTimeout(() => drawTrainBar(0, 0, stations.length), 50);
  }

  function exitRunningMode() {
    $stationPanel.classList.remove('hidden');
    $nextBanner.classList.remove('show');
    $progressSection.classList.remove('running-mode');
    setTimeout(() => drawTrainBar(0, 0, Math.max(1, stations.length)), 50);
  }

  // ==================== é§…ãƒ‡ãƒ¼ã‚¿ç®¡ç† ====================
  function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 6); }

  function saveStations() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(stations));
  }

  function loadStations() {
    try {
      const d = JSON.parse(localStorage.getItem(STORAGE_KEY));
      if (Array.isArray(d) && d.length > 0) { stations = d; renderStations(); updateMap(); }
    } catch(e) {}
  }

  function addStation(name, lat, lng) {
    stations.push({ id: genId(), name, lat, lng });
    saveStations(); renderStations(); updateMap(); updateStartButton();
  }

  function removeStation(id) {
    stations = stations.filter(s => s.id !== id);
    saveStations(); renderStations(); updateMap(); updateStartButton();
  }

  function renameStation(id, newName) {
    const s = stations.find(s => s.id === id);
    if (s) { s.name = newName; saveStations(); renderStations(); }
  }

  function moveStation(fromIdx, toIdx) {
    if (toIdx < 0 || toIdx >= stations.length) return;
    const [item] = stations.splice(fromIdx, 1);
    stations.splice(toIdx, 0, item);
    saveStations(); renderStations(); updateMap();
  }

  // ==================== é§…ãƒªã‚¹ãƒˆæç”» ====================
  function renderStations() {
    $stationList.innerHTML = '';

    // é§…ãŒ0å€‹ã®å ´åˆ: ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    if (stations.length === 0) {
      $stationPanelBottom.innerHTML = `
        <div class="onboarding">
          <div class="onboarding-icon">ğŸ </div>
          <div class="onboarding-title">ã¾ãšã¯ ãŠã†ã¡ã®ã°ã—ã‚‡ã‚’ ãˆã‚‰ã¼ã†ï¼</div>
          <div class="onboarding-desc">åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã‹ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ¤œç´¢ã—ã¦ã­</div>
          <button class="onboarding-btn" id="onboardingBtn">ğŸ” ã°ã—ã‚‡ã‚’ã•ãŒã™</button>
        </div>
      `;
      $('onboardingBtn').addEventListener('click', () => {
        $searchBar.classList.add('show');
        setTimeout(() => $searchInput.focus(), 100);
      });
      $mapHint.textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦ ãŠã†ã¡ã®ã°ã—ã‚‡ã‚’ ãˆã‚‰ã‚“ã§ã­';
      $mapHint.style.display = 'block';
      return;
    }

    // é§…ãŒã‚ã‚‹å ´åˆ
    $stationPanelBottom.innerHTML = `<div class="station-add" id="stationAdd">+ ãˆãã‚’ã¤ã„ã‹</div>`;
    $('stationAdd').addEventListener('click', () => {
      if (isRunning) return;
      $searchBar.classList.add('show');
      $mapHint.textContent = 'ã‚¿ãƒƒãƒ— or æ¤œç´¢ã§ãˆãã‚’ã¤ã„ã‹';
      $mapHint.style.display = 'block';
      setTimeout(() => $searchInput.focus(), 100);
    });

    stations.forEach((s, i) => {
      const li = document.createElement('li');
      li.className = 'station-item';
      li.dataset.index = i;

      const isFirst = i === 0;
      const isLast = i === stations.length - 1;
      const distText = i > 0
        ? formatDist(haversineDistance(stations[i-1].lat, stations[i-1].lng, s.lat, s.lng))
        : '';

      const showReorder = stations.length >= 2;
      li.innerHTML = `
        ${showReorder ? `<div class="station-reorder">
          <button data-dir="up" ${isFirst ? 'disabled' : ''}>â–²</button>
          <button data-dir="down" ${isLast ? 'disabled' : ''}>â–¼</button>
        </div>` : ''}
        <div class="station-line">
          <div class="track-top"></div>
          <div class="station-dot"></div>
          <div class="track-bottom"></div>
        </div>
        <div class="station-content">
          <div class="station-name-display" data-id="${s.id}">${s.name}é§…${isLast ? '<span class="station-badge">çµ‚ç€</span>' : ''}</div>
          ${distText ? `<div class="station-dist">${distText}</div>` : ''}
        </div>
        <button class="station-delete" data-id="${s.id}">Ã—</button>
      `;

      // ä¸¦ã¹æ›¿ãˆãƒœã‚¿ãƒ³
      li.querySelectorAll('.station-reorder button').forEach(btn => {
        const handler = e => {
          e.preventDefault();
          e.stopPropagation();
          if (btn.disabled || isRunning) return;
          const dir = btn.dataset.dir;
          if (dir === 'up') moveStation(i, i - 1);
          else moveStation(i, i + 1);
        };
        btn.addEventListener('click', handler);
        btn.addEventListener('touchend', handler);
      });

      // é§…åã‚¿ãƒƒãƒ—ã§ç·¨é›†
      const nameEl = li.querySelector('.station-name-display');
      nameEl.addEventListener('click', () => {
        if (isRunning) return;
        const input = document.createElement('input');
        input.className = 'station-name-edit';
        input.value = s.name;
        input.maxLength = 6;
        nameEl.replaceWith(input);
        input.focus();
        input.select();
        const finish = () => {
          const val = input.value.trim();
          if (val) renameStation(s.id, val);
          else renderStations();
        };
        input.addEventListener('blur', finish);
        input.addEventListener('keydown', e => { if (e.key === 'Enter') input.blur(); });
      });

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      li.querySelector('.station-delete').addEventListener('click', e => {
        e.stopPropagation();
        if (isRunning) return;
        removeStation(s.id);
      });

      $stationList.appendChild(li);
    });

    updateStationStyles();
  }

  function updateStationStyles() {
    const items = $stationList.querySelectorAll('.station-item');
    items.forEach((li, i) => {
      const tops = li.querySelector('.track-top');
      const bots = li.querySelector('.track-bottom');
      tops.style.background = i === 0 ? 'transparent' : '#E63946';
      bots.style.background = i === items.length - 1 ? 'transparent' : '#E63946';
    });
  }

  // ==================== åœ°å›³ä¸Šã®ãƒãƒ¼ã‚«ãƒ¼ãƒ»ãƒ«ãƒ¼ãƒˆæ›´æ–° ====================
  function updateMap() {
    stationMarkers.forEach(m => m.setMap(null));
    stationMarkers = [];
    if (routeLine) { routeLine.setMap(null); routeLine = null; }

    if (stations.length === 0) return;
    $mapHint.style.display = 'none';

    // é§…ãƒãƒ¼ã‚«ãƒ¼
    stations.forEach((s, i) => {
      const isLast = i === stations.length - 1;
      const marker = new google.maps.Marker({
        position: { lat: s.lat, lng: s.lng },
        map,
        label: {
          text: isLast ? 'â˜…' : String(i + 1),
          color: '#fff',
          fontSize: '11px', fontWeight: 'bold'
        },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: isLast ? 13 : 10,
          fillColor: isLast ? '#E63946' : '#38A169',
          fillOpacity: 1,
          strokeColor: '#fff', strokeWeight: 2,
        },
        title: s.name + 'é§…'
      });
      stationMarkers.push(marker);
    });

    // ãƒ«ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³
    if (stations.length >= 2) {
      routeLine = new google.maps.Polyline({
        path: stations.map(s => ({ lat: s.lat, lng: s.lng })),
        strokeColor: '#E63946', strokeOpacity: 0.7, strokeWeight: 4,
        geodesic: true,
        icons: [{
          icon: { path: 'M 0,-1 0,1', strokeOpacity: 1, scale: 3 },
          offset: '0', repeat: '15px'
        }]
      });
      routeLine.setMap(map);
    }

    // å…¨é§…ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚ºãƒ¼ãƒ 
    if (stations.length >= 1) {
      const bounds = new google.maps.LatLngBounds();
      stations.forEach(s => bounds.extend({ lat: s.lat, lng: s.lng }));
      map.fitBounds(bounds, 40);
    }
  }

  // ==================== é§…è¿½åŠ ãƒ•ãƒ­ãƒ¼ ====================
  map.addListener('click', e => {
    if (isRunning) return;
    const lat = e.latLng.lat(), lng = e.latLng.lng();
    openNameModal(lat, lng);
  });

  function openNameModal(lat, lng) {
    pendingStationLatLng = { lat, lng };
    $nameInput.value = '';
    $nameModal.classList.add('show');
    // ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ã®ãƒ’ãƒ³ãƒˆ
    if (stations.length === 0) {
      $nameInput.placeholder = 'ãŠã†ã¡';
    } else {
      $nameInput.placeholder = 'ã“ã†ãˆã‚“';
    }
    setTimeout(() => $nameInput.focus(), 100);
  }

  $nameCancel.addEventListener('click', () => {
    $nameModal.classList.remove('show');
    pendingStationLatLng = null;
  });

  $nameOk.addEventListener('click', confirmStationName);
  $nameInput.addEventListener('keydown', e => { if (e.key === 'Enter') confirmStationName(); });

  function confirmStationName() {
    const name = $nameInput.value.trim();
    if (!name || !pendingStationLatLng) return;
    addStation(name, pendingStationLatLng.lat, pendingStationLatLng.lng);
    $nameModal.classList.remove('show');
    $searchBar.classList.remove('show');
    $mapHint.style.display = 'none';
    pendingStationLatLng = null;
  }

  // ==================== æ¤œç´¢ ====================
  $searchBtn.addEventListener('click', doSearch);
  $searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
  $searchClose.addEventListener('click', () => {
    $searchBar.classList.remove('show');
    $searchResults.classList.remove('show');
    $mapHint.style.display = 'none';
  });

  function doSearch() {
    const q = $searchInput.value.trim();
    if (!q) return;
    $searchBtn.disabled = true;
    placesService.textSearch({ query: q, language: 'ja', region: 'jp' }, (results, status) => {
      $searchBtn.disabled = false;
      $searchResults.innerHTML = '';
      if (status === google.maps.places.PlacesServiceStatus.OK && results.length) {
        results.slice(0, 5).forEach(r => {
          const item = document.createElement('div');
          item.className = 'sr-item';
          item.innerHTML = `<div class="sr-name">${r.name}</div><div class="sr-addr">${r.formatted_address || ''}</div>`;
          item.addEventListener('click', () => {
            const lat = r.geometry.location.lat(), lng = r.geometry.location.lng();
            map.setCenter({ lat, lng }); map.setZoom(16);
            $searchResults.classList.remove('show');
            $searchInput.value = '';
            $searchInput.blur();
            openNameModal(lat, lng);
            setTimeout(() => { $nameInput.value = r.name.slice(0, 6); }, 100);
          });
          $searchResults.appendChild(item);
        });
      } else {
        $searchResults.innerHTML = '<div class="sr-item"><div class="sr-name">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div></div>';
      }
      const close = document.createElement('div');
      close.className = 'sr-close';
      close.textContent = 'Ã— é–‰ã˜ã‚‹';
      close.addEventListener('click', () => $searchResults.classList.remove('show'));
      $searchResults.appendChild(close);
      $searchResults.classList.add('show');
    });
  }

  // ==================== BLE ====================
  $btnBle.addEventListener('click', async () => {
    try {
      $btnBle.textContent = 'æ¥ç¶šä¸­...';
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'OsampoMeter' }],
        optionalServices: [SERVICE_UUID]
      });
      bleDevice.addEventListener('gattserverdisconnected', onBleDisconnected);
      const server = await bleDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
      $bleBadge.textContent = 'BLEæ¥ç¶šæ¸ˆ';
      $bleBadge.classList.add('connected');
      $btnBle.textContent = 'æ¥ç¶šæ¸ˆ';
      $btnBle.disabled = true;
    } catch(err) {
      console.error('BLE:', err);
      $btnBle.textContent = 'BLEæ¥ç¶š';
      alert('BLEæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  });

  function onBleDisconnected() {
    bleCharacteristic = null;
    $bleBadge.textContent = 'BLEåˆ‡æ–­';
    $bleBadge.classList.remove('connected');
    $btnBle.textContent = 'BLEæ¥ç¶š'; $btnBle.disabled = false;
    if (isRunning) stopTracking();
  }

  // ==================== BLEé€ä¿¡ (v2ãƒ—ãƒ­ãƒˆã‚³ãƒ«) ====================
  async function sendStationNames() {
    if (!bleCharacteristic) return;
    try {
      const clearBuf = new Uint8Array([0x02]);
      await bleCharacteristic.writeValueWithResponse(clearBuf.buffer);
      await sleep(50);
      for (let i = 0; i < stations.length; i++) {
        const nameBytes = new TextEncoder().encode(stations[i].name + 'é§…');
        const pkt = new Uint8Array(3 + Math.min(nameBytes.length, 18));
        pkt[0] = 0x01;
        pkt[1] = i;
        pkt[2] = Math.min(nameBytes.length, 18);
        pkt.set(nameBytes.slice(0, 18), 3);
        await bleCharacteristic.writeValueWithResponse(pkt.buffer);
        await sleep(50);
      }
    } catch(err) {
      console.error('é§…åé€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  async function sendProgressV2(overallProgress, distNext, distFinal, nextIdx, totalSt) {
    const clamped = Math.max(0, Math.min(100000, Math.round(overallProgress)));
    if (clamped === lastSentProgress) return;
    lastSentProgress = clamped;
    if (!bleCharacteristic) return;
    try {
      const buf = new ArrayBuffer(16);
      const v = new DataView(buf);
      v.setUint8(0, 0x00);
      v.setUint32(1, clamped, true);
      v.setUint32(5, Math.max(0, Math.round(distNext)), true);
      v.setUint32(9, Math.max(0, Math.round(distFinal)), true);
      v.setUint8(13, nextIdx);
      v.setUint8(14, totalSt);
      v.setUint8(15, 0);
      await bleCharacteristic.writeValueWithoutResponse(buf);
    } catch(err) {
      console.error('BLEé€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  // ==================== GPSè¿½è·¡ ====================
  $btnStart.addEventListener('click', () => {
    if (isRunning) stopTracking(); else startTracking();
  });

  async function startTracking() {
    if (stations.length === 0) return;
    isRunning = true;
    startDistance = null;
    maxProgress = 0;
    lastSentProgress = -1;
    nextStationIndex = 0;
    passedStations = new Array(stations.length).fill(false);

    enterRunningMode();

    $btnStart.textContent = 'ã‚¹ãƒˆãƒƒãƒ—';
    $btnStart.classList.remove('btn-start'); $btnStart.classList.add('btn-stop');
    $btnGoal.style.display = 'block';
    $nextName.textContent = stations[0].name + 'é§…';
    $progressValue.textContent = '0.000';
    $progressRemaining.textContent = '';
    drawTrainBar(0, 0, stations.length);

    await requestWakeLock();
    await sendStationNames();
    sendProgressV2(0, 0, 0, 0, stations.length);

    watchId = navigator.geolocation.watchPosition(
      onPositionUpdate, err => console.error('GPS:', err),
      { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
    );
  }

  function stopTracking() {
    isRunning = false;
    if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
    startDistance = null; maxProgress = 0;

    exitRunningMode();

    $btnStart.textContent = 'ã—ã‚…ã£ã±ã¤!';
    $btnStart.classList.remove('btn-stop'); $btnStart.classList.add('btn-start');
    $btnGoal.style.display = 'none';
    releaseWakeLock();
  }

  function onPositionUpdate(pos) {
    const lat = pos.coords.latitude, lng = pos.coords.longitude;

    if (currentMarker) currentMarker.setCenter({ lat, lng });
    else {
      currentMarker = new google.maps.Circle({
        map, center: { lat, lng }, radius: 8,
        fillColor: '#4299E1', fillOpacity: 1,
        strokeColor: '#fff', strokeWeight: 2, clickable: false
      });
    }

    const finalStation = stations[stations.length - 1];
    const distToFinal = haversineDistance(lat, lng, finalStation.lat, finalStation.lng);

    if (startDistance === null) {
      startDistance = distToFinal;
      if (startDistance < GOAL_RADIUS) startDistance = GOAL_RADIUS;
    }

    // é§…é€šéãƒã‚§ãƒƒã‚¯
    for (let i = nextStationIndex; i < stations.length; i++) {
      const d = haversineDistance(lat, lng, stations[i].lat, stations[i].lng);
      const radius = (i === stations.length - 1) ? GOAL_RADIUS : STATION_ARRIVAL_RADIUS;
      if (d <= radius && !passedStations[i]) {
        passedStations[i] = true;
        if (i === nextStationIndex) {
          nextStationIndex = Math.min(i + 1, stations.length - 1);
        }
      }
    }

    const nextSt = stations[Math.min(nextStationIndex, stations.length - 1)];
    const distToNext = haversineDistance(lat, lng, nextSt.lat, nextSt.lng);
    $nextName.textContent = nextSt.name + 'é§…';
    $nextDist.textContent = 'ã®ã“ã‚Š ' + formatDist(distToNext);

    let progress;
    if (distToFinal <= GOAL_RADIUS) {
      progress = 100000;
    } else {
      progress = (1 - distToFinal / startDistance) * 100000;
      progress = Math.max(0, Math.min(99999, progress));
    }
    let progressRounded = Math.round(progress);
    if (progressRounded < maxProgress) progressRounded = maxProgress;
    else maxProgress = progressRounded;

    $progressValue.textContent = (progressRounded / 1000).toFixed(3);
    $progressRemaining.textContent = 'ã‚´ãƒ¼ãƒ«ã¾ã§ ' + formatDist(distToFinal);
    drawTrainBar(progressRounded, nextStationIndex, stations.length);
    sendProgressV2(progressRounded, distToNext, distToFinal, nextStationIndex, stations.length);
  }

  // ==================== å¼·åˆ¶ã‚´ãƒ¼ãƒ« ====================
  $btnGoal.addEventListener('click', () => {
    if (!isRunning) return;
    maxProgress = 100000;
    $progressValue.textContent = '100.000';
    $progressRemaining.textContent = 'ã‚´ãƒ¼ãƒ«!';
    $nextDist.textContent = 'ã¨ã†ã¡ã‚ƒã!';
    drawTrainBar(100000, stations.length, stations.length);
    sendProgressV2(100000, 0, 0, stations.length - 1, stations.length);
    stopTracking();
  });

  // ==================== ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ ====================
  let testTimer = null, testProgress = 0;

  $btnTest.addEventListener('click', () => {
    if (testMode) {
      testMode = false;
      if (testTimer) { clearInterval(testTimer); testTimer = null; }
      testProgress = 0;
      $btnTest.classList.remove('active');
      $bleBadge.textContent = bleCharacteristic ? 'BLEæ¥ç¶šæ¸ˆ' : 'BLEæœªæ¥ç¶š';
      $bleBadge.classList.remove('test-mode');
      $progressValue.textContent = '0.000';
      $progressRemaining.textContent = '';
      exitRunningMode();
      drawTrainBar(0, 0, Math.max(1, stations.length));
      releaseWakeLock();
    } else {
      testMode = true;
      testProgress = 0;
      $btnTest.classList.add('active');
      $bleBadge.textContent = 'ãƒ†ã‚¹ãƒˆ';
      $bleBadge.classList.add('test-mode');
      enterRunningMode();
      requestWakeLock();
      sendStationNames();

      const total = Math.max(1, stations.length);
      testTimer = setInterval(() => {
        testProgress += 167;
        if (testProgress > 100000) testProgress = 100000;
        const fakeSt = Math.floor((testProgress / 100000) * total);
        $progressValue.textContent = (testProgress / 1000).toFixed(3);
        $progressRemaining.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';
        if (stations.length > 0) {
          const idx = Math.min(fakeSt, stations.length - 1);
          $nextName.textContent = stations[idx].name + 'é§…';
          $nextDist.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';
        }
        drawTrainBar(testProgress, fakeSt, total);
        sendProgressV2(testProgress, 100, 500, Math.min(fakeSt, total - 1), total);
        if (testProgress >= 100000) { clearInterval(testTimer); testTimer = null; }
      }, 100);
    }
  });

  // ==================== é›»è»Šãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æç”» ====================
  function drawTrainBar(progress, nextIdx, totalStations) {
    const canvas = trainCanvas;
    const dpr = window.devicePixelRatio || 1;
    const W = canvas.clientWidth, H = canvas.clientHeight;
    if (W === 0 || H === 0) return;
    canvas.width = W * dpr; canvas.height = H * dpr;
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);

    const padX = 16, trackY = H / 2 + 2;
    const trackW = W - 2 * padX;

    // æ•æœ¨
    ctx.strokeStyle = '#E2E8F0';
    ctx.lineWidth = 1;
    for (let x = padX; x <= padX + trackW; x += 8) {
      ctx.beginPath();
      ctx.moveTo(x, trackY - 5); ctx.lineTo(x, trackY + 5);
      ctx.stroke();
    }

    // ãƒ¬ãƒ¼ãƒ«
    ctx.strokeStyle = '#A0AEC0';
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(padX, trackY - 3); ctx.lineTo(padX + trackW, trackY - 3); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(padX, trackY + 3); ctx.lineTo(padX + trackW, trackY + 3); ctx.stroke();

    // é§…ãƒãƒ¼ã‚«ãƒ¼
    const stSize = H > 40 ? 6 : 4.5;
    const stSizeLast = H > 40 ? 7.5 : 5.5;
    for (let i = 0; i < totalStations; i++) {
      const x = padX + (trackW * (i + 1)) / (totalStations + 1);
      const isLast = i === totalStations - 1;
      ctx.beginPath();
      ctx.arc(x, trackY, isLast ? stSizeLast : stSize, 0, Math.PI * 2);
      if (i < nextIdx) {
        ctx.fillStyle = '#38A169'; ctx.fill();
      } else if (isLast) {
        ctx.fillStyle = '#E63946'; ctx.fill();
      } else {
        ctx.fillStyle = '#fff'; ctx.fill();
        ctx.strokeStyle = '#A0AEC0'; ctx.lineWidth = 1.5; ctx.stroke();
      }
    }

    // é›»è»Šã‚¢ã‚¤ã‚³ãƒ³
    const trainX = padX + (trackW * Math.min(progress, 100000)) / 100000;
    const tw = H > 40 ? 18 : 14, th = H > 40 ? 12 : 9;
    ctx.fillStyle = '#E63946';
    ctx.beginPath();
    ctx.roundRect(trainX - tw/2, trackY - th - 5, tw, th, 2);
    ctx.fill();
    // çª“
    ctx.fillStyle = '#FFF5F5';
    const ww = H > 40 ? 4 : 3;
    ctx.fillRect(trainX - tw/2 + 3, trackY - th - 3, ww, ww);
    ctx.fillRect(trainX + tw/2 - 3 - ww, trackY - th - 3, ww, ww);
    // å‰é¢ãƒ©ã‚¤ãƒ³
    ctx.fillStyle = '#fff';
    ctx.fillRect(trainX - tw/2, trackY - 6, tw, 1.5);
  }

  // ==================== Wake Lock ====================
  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
      }
    } catch(e) {}
  }
  function releaseWakeLock() {
    if (wakeLock) { wakeLock.release(); wakeLock = null; }
  }
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && (isRunning || testMode)) requestWakeLock();
  });

  // ==================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====================
  function haversineDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000, toRad = d => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1), dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLng/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function formatDist(m) {
    return m >= 1000 ? (m/1000).toFixed(1) + ' km' : Math.round(m) + ' m';
  }

  function updateStartButton() {
    $btnStart.disabled = stations.length === 0;
  }

  // ==================== åˆæœŸåŒ– ====================
  loadStations();
  updateStartButton();
  drawTrainBar(0, 0, Math.max(1, stations.length));
}
</script>
</body>
</html>
