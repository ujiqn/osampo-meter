<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>„Åä„Åï„Çì„ÅΩ„É°„Éº„Çø„Éº</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üö∂</text></svg>">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    height: 100%;
    overflow: hidden;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #1a1a2e;
    color: #fff;
    display: flex;
    flex-direction: column;
  }

  /* „Éò„ÉÉ„ÉÄ„Éº */
  .header {
    padding: 10px 16px;
    background: #16213e;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    flex-shrink: 0;
  }
  .header h1 {
    font-size: 18px;
    white-space: nowrap;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .ble-status {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 12px;
    background: #333;
    white-space: nowrap;
  }
  .ble-status.connected { background: #0a6e3a; }
  .ble-status.test-mode { background: #b45309; }
  .btn-test-small {
    font-size: 10px;
    padding: 3px 8px;
    border: 1px solid #666;
    border-radius: 8px;
    background: transparent;
    color: #888;
    cursor: pointer;
    white-space: nowrap;
  }
  .btn-test-small.active {
    background: #b45309;
    border-color: #b45309;
    color: #fff;
  }

  /* Ê§úÁ¥¢„Éê„Éº */
  .search-bar {
    display: flex;
    gap: 8px;
    padding: 8px 16px;
    background: #16213e;
    flex-shrink: 0;
  }
  .search-bar input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #444;
    border-radius: 8px;
    background: #0f1629;
    color: #fff;
    font-size: 15px;
    outline: none;
  }
  .search-bar input:focus {
    border-color: #2563eb;
  }
  .search-bar input::placeholder {
    color: #666;
  }
  .search-bar button {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: #fff;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    white-space: nowrap;
  }
  .search-bar button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Ê§úÁ¥¢ÁµêÊûú */
  .search-results {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: #1a1a2e;
    z-index: 2000;
    max-height: 100%;
    overflow-y: auto;
    display: none;
  }
  .search-results.show { display: block; }
  .search-result-item {
    padding: 12px 16px;
    border-bottom: 1px solid #333;
    cursor: pointer;
  }
  .search-result-item:active {
    background: #2563eb33;
  }
  .search-result-name {
    font-size: 15px;
    color: #fff;
  }
  .search-result-address {
    font-size: 12px;
    color: #888;
    margin-top: 2px;
  }
  .search-results-close {
    padding: 12px 16px;
    text-align: center;
    color: #f87171;
    cursor: pointer;
    font-size: 14px;
  }

  /* Âú∞Âõ≥ */
  #map-container {
    position: relative;
    flex: 1;
    min-height: 200px;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  .map-hint {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 6px 14px;
    border-radius: 16px;
    font-size: 13px;
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
  }

  /* ÁõÆÁöÑÂú∞ÊÉÖÂ†± */
  .dest-info {
    padding: 8px 16px;
    font-size: 13px;
    color: #aaa;
    background: #16213e;
    text-align: center;
    flex-shrink: 0;
  }
  .dest-info .dest-name {
    color: #fff;
    font-weight: bold;
  }
  .dest-info .dest-clear {
    color: #f87171;
    margin-left: 8px;
    cursor: pointer;
    text-decoration: underline;
  }

  /* ÈÄ≤ÊçóË°®Á§∫ */
  .progress-display {
    text-align: center;
    padding: 12px;
    background: #16213e;
    flex-shrink: 0;
  }
  .progress-number {
    font-size: 48px;
    font-weight: bold;
    color: #0ff;
    font-variant-numeric: tabular-nums;
  }
  .progress-bar-container {
    margin: 8px auto 0;
    width: 90%;
    height: 10px;
    background: #333;
    border-radius: 5px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    background: #0ff;
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 5px;
  }
  .progress-distance {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
  }

  /* „Ç≥„É≥„Éà„É≠„Éº„É´ */
  .controls {
    padding: 12px 16px;
    display: flex;
    gap: 10px;
    background: #16213e;
    flex-shrink: 0;
  }
  .btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-ble {
    background: #2563eb;
    color: #fff;
  }
  .btn-start {
    background: #16a34a;
    color: #fff;
  }
  .btn-stop {
    background: #dc2626;
    color: #fff;
  }
  .btn-goal {
    background: linear-gradient(135deg, #f59e0b, #ef4444);
    color: #fff;
  }

</style>
</head>
<body>

<div class="header">
  <h1>üö∂ „Åä„Åï„Çì„ÅΩ„É°„Éº„Çø„Éº</h1>
  <div class="header-right">
    <span class="ble-status" id="bleStatus">BLEÊú™Êé•Á∂ö</span>
    <button class="btn-test-small" id="btnTest">TEST</button>
  </div>
</div>

<!-- Ê§úÁ¥¢„Éê„Éº -->
<div class="search-bar">
  <input type="text" id="searchInput" placeholder="Â†¥ÊâÄ„ÇíÊ§úÁ¥¢Ôºà‰æã: Êù±‰∫¨„Çø„ÉØ„ÉºÔºâ" enterkeyhint="search">
  <button id="searchBtn">Ê§úÁ¥¢</button>
</div>

<div id="map-container">
  <div class="map-hint" id="mapHint">Ê§úÁ¥¢ or „Çø„ÉÉ„Éó„ÅßÁõÆÁöÑÂú∞„ÇíË®≠ÂÆö</div>
  <div class="search-results" id="searchResults"></div>
  <div id="map"></div>
</div>

<div class="dest-info" id="destInfo" style="display:none;">
  üèÅ <span class="dest-name" id="destName"></span>
  <span class="dest-clear" id="destClear">„ÇØ„É™„Ç¢</span>
</div>

<div class="progress-display">
  <div class="progress-number"><span id="progressValue">0.000</span>%</div>
  <div class="progress-bar-container">
    <div class="progress-bar-fill" id="progressBar"></div>
  </div>
  <div class="progress-distance" id="progressDistance"></div>
</div>

<div class="controls">
  <button class="btn btn-ble" id="btnBle">BLEÊé•Á∂ö</button>
  <button class="btn btn-start" id="btnStart" disabled>„Çπ„Çø„Éº„Éà</button>
  <button class="btn btn-goal" id="btnGoal" style="display:none;">„Ç¥„Éº„É´ÔºÅ</button>
</div>

<script>
// ==================== API„Ç≠„Éº ====================
const GMAP_API_KEY = 'AIzaSyDnmItjYjosd4qMt63vWkxY2twew-JVRnA';

// Google Maps API„Çí„É≠„Éº„Éâ
function loadGoogleMaps() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GMAP_API_KEY}&libraries=places&language=ja`;
    script.onload = resolve;
    script.onerror = () => reject(new Error('Google Maps Ë™≠„ÅøËæº„ÅøÂ§±Êïó'));
    document.head.appendChild(script);
  });
}

// ==================== „É°„Ç§„É≥„ÅÆÂàùÊúüÂåñ ====================
loadGoogleMaps().then(initApp).catch((err) => {
  console.error(err.message);
  alert('Google Maps„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
});

function initApp() {
  const mapEl = document.getElementById('map');

  // ==================== ÂÆöÊï∞ ====================
  const SERVICE_UUID        = '12345678-1234-1234-1234-123456789abc';
  const CHARACTERISTIC_UUID = '12345678-1234-1234-1234-123456789def';
  const STORAGE_KEY = 'osampo_destination';
  const GOAL_RADIUS_M = 10;

  // ==================== Áä∂ÊÖã ====================
  let bleDevice = null;
  let bleCharacteristic = null;
  let watchId = null;
  let startDistance = null;
  let destination = null;
  let destMarker = null;
  let currentMarker = null;
  let isRunning = false;
  let lastSentProgress = -1;
  let testMode = false;
  let maxProgress = 0; // ÈÄ≤Êçó„ÅÆÊúÄÂ§ßÂÄ§„ÇíË®òÈå≤ÔºàÊ∏õ„Çâ„Åï„Å™„ÅÑÔºâ
  let searchBox = null;
  let wakeLock = null; // ÁîªÈù¢„Çπ„É™„Éº„ÉóÈò≤Ê≠¢

  // ==================== DOM ====================
  const $bleStatus = document.getElementById('bleStatus');
  const $btnBle = document.getElementById('btnBle');
  const $btnTest = document.getElementById('btnTest');
  const $btnStart = document.getElementById('btnStart');
  const $progressValue = document.getElementById('progressValue');
  const $progressBar = document.getElementById('progressBar');
  const $progressDistance = document.getElementById('progressDistance');
  const $mapHint = document.getElementById('mapHint');
  const $destInfo = document.getElementById('destInfo');
  const $destName = document.getElementById('destName');
  const $destClear = document.getElementById('destClear');
  const $searchInput = document.getElementById('searchInput');
  const $searchBtn = document.getElementById('searchBtn');
  const $searchResults = document.getElementById('searchResults');
  const $btnGoal = document.getElementById('btnGoal');

  // ==================== Google MapÂàùÊúüÂåñ ====================
  const map = new google.maps.Map(mapEl, {
    center: { lat: 35.6812, lng: 139.7671 },
    zoom: 15,
    disableDefaultUI: true,
    zoomControl: false,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false,
    styles: [
      { elementType: 'geometry', stylers: [{ color: '#1d2c4d' }] },
      { elementType: 'labels.text.fill', stylers: [{ color: '#8ec3b9' }] },
      { elementType: 'labels.text.stroke', stylers: [{ color: '#1a3646' }] },
      { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#304a7d' }] },
      { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#98a5be' }] },
      { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e1626' }] },
      { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#6f9ba5' }] },
      { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#1a3c34' }] },
    ]
  });

  // ÁèæÂú®Âú∞„Å´ÁßªÂãï
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setCenter(loc);
        map.setZoom(16);
        if (!currentMarker) {
          currentMarker = new google.maps.Circle({
            map, center: loc,
            radius: 8, fillColor: '#3b82f6', fillOpacity: 1,
            strokeColor: '#fff', strokeWeight: 2, clickable: false
          });
        }
      },
      () => {},
      { enableHighAccuracy: true }
    );
  }

  // ‰øùÂ≠òÊ∏à„ÅøÁõÆÁöÑÂú∞„ÅÆÂæ©ÂÖÉ
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const d = JSON.parse(saved);
      if (d.lat && d.lng) {
        setDestination(d.lat, d.lng, d.name || '‰øùÂ≠òÊ∏à„ÅøÂú∞ÁÇπ', false);
      }
    } catch (e) {}
  }

  // Âú∞Âõ≥„Çø„ÉÉ„Éó„ÅßÁõÆÁöÑÂú∞Ë®≠ÂÆö
  map.addListener('click', (e) => {
    if (isRunning) return;
    const lat = e.latLng.lat();
    const lng = e.latLng.lng();
    setDestination(lat, lng, `${lat.toFixed(5)}, ${lng.toFixed(5)}`, true);
  });

  // ==================== Ê§úÁ¥¢ (Google Places) ====================
  $searchBtn.addEventListener('click', doSearch);
  $searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') doSearch();
  });

  const placesService = new google.maps.places.PlacesService(map);

  function doSearch() {
    const query = $searchInput.value.trim();
    if (!query) return;

    $searchBtn.disabled = true;
    $searchBtn.textContent = '...';

    const request = {
      query: query,
      fields: ['name', 'geometry', 'formatted_address'],
      language: 'ja',
      region: 'jp'
    };

    placesService.textSearch(request, (results, status) => {
      $searchBtn.disabled = false;
      $searchBtn.textContent = 'Ê§úÁ¥¢';

      $searchResults.innerHTML = '';

      if (status !== google.maps.places.PlacesServiceStatus.OK || !results.length) {
        $searchResults.innerHTML = '<div class="search-result-item"><div class="search-result-name">Ë¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</div></div>';
      } else {
        results.slice(0, 5).forEach((r) => {
          const item = document.createElement('div');
          item.className = 'search-result-item';
          item.innerHTML = `
            <div class="search-result-name">${r.name}</div>
            <div class="search-result-address">${r.formatted_address || ''}</div>
          `;
          item.addEventListener('click', () => {
            const lat = r.geometry.location.lat();
            const lng = r.geometry.location.lng();
            setDestination(lat, lng, r.name, true);
            map.setCenter({ lat, lng });
            map.setZoom(16);
            $searchResults.classList.remove('show');
            $searchInput.value = r.name;
            $searchInput.blur();
          });
          $searchResults.appendChild(item);
        });
      }

      const closeBtn = document.createElement('div');
      closeBtn.className = 'search-results-close';
      closeBtn.textContent = '‚úï Èñâ„Åò„Çã';
      closeBtn.addEventListener('click', () => {
        $searchResults.classList.remove('show');
      });
      $searchResults.appendChild(closeBtn);
      $searchResults.classList.add('show');
    });
  }

  // ==================== ÁõÆÁöÑÂú∞Ë®≠ÂÆö ====================
  function setDestination(lat, lng, name, save) {
    destination = { lat, lng, name };

    if (destMarker) {
      destMarker.setPosition({ lat, lng });
    } else {
      destMarker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        label: { text: 'üèÅ', fontSize: '20px' },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 16,
          fillColor: '#f43f5e',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 2,
        }
      });
    }

    $mapHint.style.display = 'none';
    $destInfo.style.display = 'block';
    $destName.textContent = name;
    updateStartButton();

    if (save) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ lat, lng, name }));
    }
  }

  $destClear.addEventListener('click', () => {
    if (isRunning) return;
    destination = null;
    if (destMarker) {
      destMarker.setMap(null);
      destMarker = null;
    }
    $destInfo.style.display = 'none';
    $mapHint.style.display = 'block';
    $searchInput.value = '';
    localStorage.removeItem(STORAGE_KEY);
    updateStartButton();
  });

  // ==================== „ÉÜ„Çπ„Éà„É¢„Éº„ÉâÔºà1ÂàÜ„Åß100%„Éá„É¢Ôºâ ====================
  let testTimer = null;
  let testProgress = 0;

  $btnTest.addEventListener('click', () => {
    if (testMode) {
      // „ÉÜ„Çπ„ÉàÂÅúÊ≠¢
      testMode = false;
      if (testTimer) { clearInterval(testTimer); testTimer = null; }
      testProgress = 0;
      $btnTest.textContent = 'TEST';
      $btnTest.classList.remove('active');
      $bleStatus.textContent = bleCharacteristic ? 'BLEÊé•Á∂öÊ∏à„Åø' : 'BLEÊú™Êé•Á∂ö';
      $bleStatus.classList.remove('test-mode');
      $progressValue.textContent = '0.000';
      $progressBar.style.width = '0%';
      $progressDistance.textContent = '';
      releaseWakeLock();
    } else {
      // „ÉÜ„Çπ„ÉàÈñãÂßã: 1ÂàÜ(60Áßí)„Åß0‚Üí100%„ÄÅ100ms„Åî„Å®„Å´Êõ¥Êñ∞
      testMode = true;
      testProgress = 0;
      $btnTest.textContent = 'TEST';
      $btnTest.classList.add('active');
      $bleStatus.textContent = '„ÉÜ„Çπ„Éà„É¢„Éº„Éâ';
      $bleStatus.classList.add('test-mode');

      requestWakeLock();
      // 60Áßí = 60000ms„ÄÅ100ms„Åî„Å®„Å´Êõ¥Êñ∞ ‚Üí 600Âõû„Åß100000„Å´Âà∞ÈÅî
      // ÊØéÂõû„ÅÆÂ¢óÂàÜ = 100000 / 600 ‚âí 167
      testTimer = setInterval(() => {
        testProgress += 167;
        if (testProgress >= 100000) testProgress = 100000;

        const displayPct = (testProgress / 1000).toFixed(3);
        $progressValue.textContent = displayPct;
        $progressBar.style.width = (testProgress / 1000) + '%';
        $progressDistance.textContent = '„ÉÜ„Çπ„Éà‰∏≠...';

        // BLEÈÄÅ‰ø°ÔºàM5StickCÊé•Á∂ö‰∏≠„Å™„ÇâÈÄÅ„ÇãÔºâ
        sendProgress(testProgress);

        if (testProgress >= 100000) {
          clearInterval(testTimer);
          testTimer = null;
        }
      }, 100);
    }
  });

  // ==================== BLE ====================
  $btnBle.addEventListener('click', async () => {
    try {
      $btnBle.textContent = 'Êé•Á∂ö‰∏≠...';
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'OsampoMeter' }],
        optionalServices: [SERVICE_UUID]
      });
      bleDevice.addEventListener('gattserverdisconnected', onBleDisconnected);
      const server = await bleDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
      $bleStatus.textContent = 'BLEÊé•Á∂öÊ∏à„Åø';
      $bleStatus.classList.add('connected');
      $btnBle.textContent = 'BLEÊé•Á∂öÊ∏à„Åø';
      $btnBle.disabled = true;
      updateStartButton();
    } catch (err) {
      console.error('BLEÊé•Á∂ö„Ç®„É©„Éº:', err);
      $btnBle.textContent = 'BLEÊé•Á∂ö';
      alert('BLEÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n„Éá„Éê„Ç§„Çπ„ÅÆÈõªÊ∫ê„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    }
  });

  function onBleDisconnected() {
    bleCharacteristic = null;
    $bleStatus.textContent = 'BLEÂàáÊñ≠';
    $bleStatus.classList.remove('connected');
    $btnBle.textContent = 'BLEÊé•Á∂ö';
    $btnBle.disabled = false;
    if (isRunning) stopTracking();
    updateStartButton();
  }

  async function sendProgress(value) {
    const clamped = Math.max(0, Math.min(100000, Math.round(value)));
    if (clamped === lastSentProgress) return;
    lastSentProgress = clamped;
    if (!bleCharacteristic) return;
    try {
      const buf = new ArrayBuffer(4);
      const view = new DataView(buf);
      view.setUint32(0, clamped, true);
      await bleCharacteristic.writeValueWithoutResponse(buf);
    } catch (err) {
      console.error('BLEÈÄÅ‰ø°„Ç®„É©„Éº:', err);
    }
  }

  // ==================== GPSËøΩË∑° ====================
  $btnStart.addEventListener('click', () => {
    if (isRunning) { stopTracking(); } else { startTracking(); }
  });

  function startTracking() {
    if (!destination) return;

    isRunning = true;
    startDistance = null;
    lastSentProgress = -1;
    maxProgress = 0;
    $btnStart.textContent = '„Çπ„Éà„ÉÉ„Éó';
    $btnStart.classList.remove('btn-start');
    $btnStart.classList.add('btn-stop');
    $btnGoal.style.display = 'block';
    $progressValue.textContent = '0.000';
    $progressBar.style.width = '0%';
    $progressDistance.textContent = '';

    sendProgress(0);
    requestWakeLock();

    watchId = navigator.geolocation.watchPosition(
      onPositionUpdate, onPositionError,
      { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
    );
  }

  function stopTracking() {
    isRunning = false;
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    startDistance = null;
    maxProgress = 0;
    $btnStart.textContent = '„Çπ„Çø„Éº„Éà';
    $btnStart.classList.remove('btn-stop');
    $btnStart.classList.add('btn-start');
    $btnGoal.style.display = 'none';
    releaseWakeLock();
  }

  function onPositionUpdate(pos) {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    // ÁèæÂú®Âú∞„Éû„Éº„Ç´„Éº„ÇíÊõ¥Êñ∞
    if (currentMarker) {
      currentMarker.setCenter({ lat, lng });
    } else {
      currentMarker = new google.maps.Circle({
        map, center: { lat, lng },
        radius: 8, fillColor: '#3b82f6', fillOpacity: 1,
        strokeColor: '#fff', strokeWeight: 2, clickable: false
      });
    }

    const dist = haversineDistance(lat, lng, destination.lat, destination.lng);

    // Âá∫Áô∫ÊôÇ„ÅÆË∑ùÈõ¢„ÇíË®òÈå≤
    if (startDistance === null) {
      startDistance = dist;
      if (startDistance < GOAL_RADIUS_M) {
        startDistance = GOAL_RADIUS_M;
      }
    }

    // ÈÄ≤ÊçóË®àÁÆó
    let progress;
    if (dist <= GOAL_RADIUS_M) {
      progress = 100000;
    } else {
      progress = (1 - dist / startDistance) * 100000;
      progress = Math.max(0, Math.min(99999, progress));
    }

    let progressRounded = Math.round(progress);

    // ‚òÖ ÈÄ≤Êçó„ÅØÊ∏õ„Çâ„Åï„Å™„ÅÑÔºàÊúÄÂ§ßÂÄ§„Çí‰øùÊåÅÔºâ
    if (progressRounded < maxProgress) {
      progressRounded = maxProgress;
    } else {
      maxProgress = progressRounded;
    }

    // UIÊõ¥Êñ∞
    const displayPct = (progressRounded / 1000).toFixed(3);
    $progressValue.textContent = displayPct;
    $progressBar.style.width = (progressRounded / 1000) + '%';

    // ÊÆã„ÇäË∑ùÈõ¢„ÇíË°®Á§∫
    if (dist >= 1000) {
      $progressDistance.textContent = `ÊÆã„Çä ${(dist / 1000).toFixed(1)} km`;
    } else {
      $progressDistance.textContent = `ÊÆã„Çä ${Math.round(dist)} m`;
    }

    // BLEÈÄÅ‰ø°
    sendProgress(progressRounded);
  }

  function onPositionError(err) {
    console.error('GPS „Ç®„É©„Éº:', err);
  }

  // ==================== Âº∑Âà∂„Ç¥„Éº„É´ ====================
  $btnGoal.addEventListener('click', () => {
    if (!isRunning) return;
    maxProgress = 100000;
    $progressValue.textContent = '100.000';
    $progressBar.style.width = '100%';
    $progressDistance.textContent = '„Ç¥„Éº„É´ÔºÅ';
    sendProgress(100000);
    stopTracking();
  });

  // ==================== Wake LockÔºàÁîªÈù¢„Çπ„É™„Éº„ÉóÈò≤Ê≠¢Ôºâ ====================
  async function requestWakeLock() {
    try {
      if ('wakeLock' in navigator) {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('Wake Lock: ON');
        wakeLock.addEventListener('release', () => {
          console.log('Wake Lock: released');
        });
      }
    } catch (err) {
      console.log('Wake LockÂèñÂæóÂ§±Êïó:', err);
    }
  }

  function releaseWakeLock() {
    if (wakeLock) {
      wakeLock.release();
      wakeLock = null;
      console.log('Wake Lock: OFF');
    }
  }

  // „Éö„Éº„Ç∏„ÅåÂÜçË°®Á§∫„Åï„Çå„Åü„Å®„ÅçÔºà„Éù„Ç±„ÉÉ„Éà„Åã„ÇâÂá∫„Åó„ÅüÁ≠âÔºâ„Å´Wake Lock„ÇíÂÜçÂèñÂæó
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && (isRunning || testMode)) {
      requestWakeLock();
    }
  });

  // ==================== „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ ====================
  function haversineDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const toRad = (deg) => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateStartButton() {
    $btnStart.disabled = !destination;
  }
}

</script>
</body>
</html>
