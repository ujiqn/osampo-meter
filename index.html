<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ãŠã•ã‚“ã½ãƒ¡ãƒ¼ã‚¿ãƒ¼</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš¶</text></svg>">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    height: 100%;
    overflow: hidden;
  }
  body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #1a1a2e;
    color: #fff;
    display: flex;
    flex-direction: column;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header {
    padding: 10px 16px;
    background: #16213e;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    flex-shrink: 0;
  }
  .header h1 {
    font-size: 18px;
    white-space: nowrap;
  }
  .ble-status {
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 12px;
    background: #333;
    white-space: nowrap;
  }
  .ble-status.connected { background: #0a6e3a; }
  .ble-status.test-mode { background: #b45309; }

  /* æ¤œç´¢ãƒãƒ¼ */
  .search-bar {
    display: flex;
    gap: 8px;
    padding: 8px 16px;
    background: #16213e;
    flex-shrink: 0;
  }
  .search-bar input {
    flex: 1;
    padding: 10px 12px;
    border: 1px solid #444;
    border-radius: 8px;
    background: #0f1629;
    color: #fff;
    font-size: 15px;
    outline: none;
  }
  .search-bar input:focus {
    border-color: #2563eb;
  }
  .search-bar input::placeholder {
    color: #666;
  }
  .search-bar button {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: #fff;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    white-space: nowrap;
  }
  .search-bar button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* æ¤œç´¢çµæœ */
  .search-results {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: #1a1a2e;
    z-index: 2000;
    max-height: 100%;
    overflow-y: auto;
    display: none;
  }
  .search-results.show { display: block; }
  .search-result-item {
    padding: 12px 16px;
    border-bottom: 1px solid #333;
    cursor: pointer;
  }
  .search-result-item:active {
    background: #2563eb33;
  }
  .search-result-name {
    font-size: 15px;
    color: #fff;
  }
  .search-result-address {
    font-size: 12px;
    color: #888;
    margin-top: 2px;
  }
  .search-results-close {
    padding: 12px 16px;
    text-align: center;
    color: #f87171;
    cursor: pointer;
    font-size: 14px;
  }

  /* åœ°å›³ */
  #map-container {
    position: relative;
    flex: 1;
    min-height: 200px;
  }
  #map {
    width: 100%;
    height: 100%;
  }
  .map-hint {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    padding: 6px 14px;
    border-radius: 16px;
    font-size: 13px;
    pointer-events: none;
    z-index: 1000;
    white-space: nowrap;
  }

  /* ç›®çš„åœ°æƒ…å ± */
  .dest-info {
    padding: 8px 16px;
    font-size: 13px;
    color: #aaa;
    background: #16213e;
    text-align: center;
    flex-shrink: 0;
  }
  .dest-info .dest-name {
    color: #fff;
    font-weight: bold;
  }
  .dest-info .dest-clear {
    color: #f87171;
    margin-left: 8px;
    cursor: pointer;
    text-decoration: underline;
  }

  /* é€²æ—è¡¨ç¤º */
  .progress-display {
    text-align: center;
    padding: 12px;
    background: #16213e;
    flex-shrink: 0;
  }
  .progress-number {
    font-size: 48px;
    font-weight: bold;
    color: #0ff;
    font-variant-numeric: tabular-nums;
  }
  .progress-bar-container {
    margin: 8px auto 0;
    width: 90%;
    height: 10px;
    background: #333;
    border-radius: 5px;
    overflow: hidden;
  }
  .progress-bar-fill {
    height: 100%;
    background: #0ff;
    width: 0%;
    transition: width 0.3s ease;
    border-radius: 5px;
  }
  .progress-distance {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
  }

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
  .controls {
    padding: 12px 16px;
    display: flex;
    gap: 10px;
    background: #16213e;
    flex-shrink: 0;
  }
  .btn {
    flex: 1;
    padding: 14px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-ble {
    background: #2563eb;
    color: #fff;
  }
  .btn-test {
    background: #b45309;
    color: #fff;
  }
  .btn-start {
    background: #16a34a;
    color: #fff;
  }
  .btn-stop {
    background: #dc2626;
    color: #fff;
  }

</style>
</head>
<body>

<div class="header">
  <h1>ğŸš¶ ãŠã•ã‚“ã½ãƒ¡ãƒ¼ã‚¿ãƒ¼</h1>
  <span class="ble-status" id="bleStatus">BLEæœªæ¥ç¶š</span>
</div>

<!-- æ¤œç´¢ãƒãƒ¼ -->
<div class="search-bar">
  <input type="text" id="searchInput" placeholder="å ´æ‰€ã‚’æ¤œç´¢ï¼ˆä¾‹: æ±äº¬ã‚¿ãƒ¯ãƒ¼ï¼‰" enterkeyhint="search">
  <button id="searchBtn">æ¤œç´¢</button>
</div>

<div id="map-container">
  <div class="map-hint" id="mapHint">æ¤œç´¢ or ã‚¿ãƒƒãƒ—ã§ç›®çš„åœ°ã‚’è¨­å®š</div>
  <div class="search-results" id="searchResults"></div>
  <div id="map"></div>
</div>

<div class="dest-info" id="destInfo" style="display:none;">
  ğŸ <span class="dest-name" id="destName"></span>
  <span class="dest-clear" id="destClear">ã‚¯ãƒªã‚¢</span>
</div>

<div class="progress-display">
  <div class="progress-number"><span id="progressValue">0.000</span>%</div>
  <div class="progress-bar-container">
    <div class="progress-bar-fill" id="progressBar"></div>
  </div>
  <div class="progress-distance" id="progressDistance"></div>
</div>

<div class="controls">
  <button class="btn btn-ble" id="btnBle">BLEæ¥ç¶š</button>
  <button class="btn btn-test" id="btnTest">ãƒ†ã‚¹ãƒˆ</button>
  <button class="btn btn-start" id="btnStart" disabled>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<script>
// ==================== APIã‚­ãƒ¼ ====================
const GMAP_API_KEY = 'AIzaSyDnmItjYjosd4qMt63vWkxY2twew-JVRnA';

// Google Maps APIã‚’ãƒ­ãƒ¼ãƒ‰
function loadGoogleMaps() {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GMAP_API_KEY}&libraries=places&language=ja`;
    script.onload = resolve;
    script.onerror = () => reject(new Error('Google Maps èª­ã¿è¾¼ã¿å¤±æ•—'));
    document.head.appendChild(script);
  });
}

// ==================== ãƒ¡ã‚¤ãƒ³ã®åˆæœŸåŒ– ====================
loadGoogleMaps().then(initApp).catch((err) => {
  console.error(err.message);
  alert('Google Mapsã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
});

function initApp() {
  const mapEl = document.getElementById('map');

  // ==================== å®šæ•° ====================
  const SERVICE_UUID        = '12345678-1234-1234-1234-123456789abc';
  const CHARACTERISTIC_UUID = '12345678-1234-1234-1234-123456789def';
  const STORAGE_KEY = 'osampo_destination';
  const GOAL_RADIUS_M = 50;

  // ==================== çŠ¶æ…‹ ====================
  let bleDevice = null;
  let bleCharacteristic = null;
  let watchId = null;
  let startDistance = null;
  let destination = null;
  let destMarker = null;
  let currentMarker = null;
  let isRunning = false;
  let lastSentProgress = -1;
  let testMode = false;
  let maxProgress = 0; // é€²æ—ã®æœ€å¤§å€¤ã‚’è¨˜éŒ²ï¼ˆæ¸›ã‚‰ã•ãªã„ï¼‰
  let searchBox = null;

  // ==================== DOM ====================
  const $bleStatus = document.getElementById('bleStatus');
  const $btnBle = document.getElementById('btnBle');
  const $btnTest = document.getElementById('btnTest');
  const $btnStart = document.getElementById('btnStart');
  const $progressValue = document.getElementById('progressValue');
  const $progressBar = document.getElementById('progressBar');
  const $progressDistance = document.getElementById('progressDistance');
  const $mapHint = document.getElementById('mapHint');
  const $destInfo = document.getElementById('destInfo');
  const $destName = document.getElementById('destName');
  const $destClear = document.getElementById('destClear');
  const $searchInput = document.getElementById('searchInput');
  const $searchBtn = document.getElementById('searchBtn');
  const $searchResults = document.getElementById('searchResults');

  // ==================== Google MapåˆæœŸåŒ– ====================
  const map = new google.maps.Map(mapEl, {
    center: { lat: 35.6812, lng: 139.7671 },
    zoom: 15,
    disableDefaultUI: true,
    zoomControl: false,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false,
    styles: [
      { elementType: 'geometry', stylers: [{ color: '#1d2c4d' }] },
      { elementType: 'labels.text.fill', stylers: [{ color: '#8ec3b9' }] },
      { elementType: 'labels.text.stroke', stylers: [{ color: '#1a3646' }] },
      { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#304a7d' }] },
      { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#98a5be' }] },
      { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0e1626' }] },
      { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#6f9ba5' }] },
      { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#1a3c34' }] },
    ]
  });

  // ç¾åœ¨åœ°ã«ç§»å‹•
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setCenter(loc);
        map.setZoom(16);
        if (!currentMarker) {
          currentMarker = new google.maps.Circle({
            map, center: loc,
            radius: 8, fillColor: '#3b82f6', fillOpacity: 1,
            strokeColor: '#fff', strokeWeight: 2, clickable: false
          });
        }
      },
      () => {},
      { enableHighAccuracy: true }
    );
  }

  // ä¿å­˜æ¸ˆã¿ç›®çš„åœ°ã®å¾©å…ƒ
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    try {
      const d = JSON.parse(saved);
      if (d.lat && d.lng) {
        setDestination(d.lat, d.lng, d.name || 'ä¿å­˜æ¸ˆã¿åœ°ç‚¹', false);
      }
    } catch (e) {}
  }

  // åœ°å›³ã‚¿ãƒƒãƒ—ã§ç›®çš„åœ°è¨­å®š
  map.addListener('click', (e) => {
    if (isRunning) return;
    const lat = e.latLng.lat();
    const lng = e.latLng.lng();
    setDestination(lat, lng, `${lat.toFixed(5)}, ${lng.toFixed(5)}`, true);
  });

  // ==================== æ¤œç´¢ (Google Places) ====================
  $searchBtn.addEventListener('click', doSearch);
  $searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') doSearch();
  });

  const placesService = new google.maps.places.PlacesService(map);

  function doSearch() {
    const query = $searchInput.value.trim();
    if (!query) return;

    $searchBtn.disabled = true;
    $searchBtn.textContent = '...';

    const request = {
      query: query,
      fields: ['name', 'geometry', 'formatted_address'],
      language: 'ja',
      region: 'jp'
    };

    placesService.textSearch(request, (results, status) => {
      $searchBtn.disabled = false;
      $searchBtn.textContent = 'æ¤œç´¢';

      $searchResults.innerHTML = '';

      if (status !== google.maps.places.PlacesServiceStatus.OK || !results.length) {
        $searchResults.innerHTML = '<div class="search-result-item"><div class="search-result-name">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div></div>';
      } else {
        results.slice(0, 5).forEach((r) => {
          const item = document.createElement('div');
          item.className = 'search-result-item';
          item.innerHTML = `
            <div class="search-result-name">${r.name}</div>
            <div class="search-result-address">${r.formatted_address || ''}</div>
          `;
          item.addEventListener('click', () => {
            const lat = r.geometry.location.lat();
            const lng = r.geometry.location.lng();
            setDestination(lat, lng, r.name, true);
            map.setCenter({ lat, lng });
            map.setZoom(16);
            $searchResults.classList.remove('show');
            $searchInput.value = r.name;
            $searchInput.blur();
          });
          $searchResults.appendChild(item);
        });
      }

      const closeBtn = document.createElement('div');
      closeBtn.className = 'search-results-close';
      closeBtn.textContent = 'âœ• é–‰ã˜ã‚‹';
      closeBtn.addEventListener('click', () => {
        $searchResults.classList.remove('show');
      });
      $searchResults.appendChild(closeBtn);
      $searchResults.classList.add('show');
    });
  }

  // ==================== ç›®çš„åœ°è¨­å®š ====================
  function setDestination(lat, lng, name, save) {
    destination = { lat, lng, name };

    if (destMarker) {
      destMarker.setPosition({ lat, lng });
    } else {
      destMarker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        label: { text: 'ğŸ', fontSize: '20px' },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 16,
          fillColor: '#f43f5e',
          fillOpacity: 1,
          strokeColor: '#fff',
          strokeWeight: 2,
        }
      });
    }

    $mapHint.style.display = 'none';
    $destInfo.style.display = 'block';
    $destName.textContent = name;
    updateStartButton();

    if (save) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ lat, lng, name }));
    }
  }

  $destClear.addEventListener('click', () => {
    if (isRunning) return;
    destination = null;
    if (destMarker) {
      destMarker.setMap(null);
      destMarker = null;
    }
    $destInfo.style.display = 'none';
    $mapHint.style.display = 'block';
    $searchInput.value = '';
    localStorage.removeItem(STORAGE_KEY);
    updateStartButton();
  });

  // ==================== ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆ1åˆ†ã§100%ãƒ‡ãƒ¢ï¼‰ ====================
  let testTimer = null;
  let testProgress = 0;

  $btnTest.addEventListener('click', () => {
    if (testMode) {
      // ãƒ†ã‚¹ãƒˆåœæ­¢
      testMode = false;
      if (testTimer) { clearInterval(testTimer); testTimer = null; }
      testProgress = 0;
      $btnTest.textContent = 'ãƒ†ã‚¹ãƒˆ';
      $bleStatus.textContent = bleCharacteristic ? 'BLEæ¥ç¶šæ¸ˆã¿' : 'BLEæœªæ¥ç¶š';
      $bleStatus.classList.remove('test-mode');
      $progressValue.textContent = '0.000';
      $progressBar.style.width = '0%';
      $progressDistance.textContent = '';
    } else {
      // ãƒ†ã‚¹ãƒˆé–‹å§‹: 1åˆ†(60ç§’)ã§0â†’100%ã€100msã”ã¨ã«æ›´æ–°
      testMode = true;
      testProgress = 0;
      $btnTest.textContent = 'ãƒ†ã‚¹ãƒˆä¸­';
      $bleStatus.textContent = 'ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰';
      $bleStatus.classList.add('test-mode');

      // 60ç§’ = 60000msã€100msã”ã¨ã«æ›´æ–° â†’ 600å›ã§100000ã«åˆ°é”
      // æ¯å›ã®å¢—åˆ† = 100000 / 600 â‰’ 167
      testTimer = setInterval(() => {
        testProgress += 167;
        if (testProgress >= 100000) testProgress = 100000;

        const displayPct = (testProgress / 1000).toFixed(3);
        $progressValue.textContent = displayPct;
        $progressBar.style.width = (testProgress / 1000) + '%';
        $progressDistance.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';

        // BLEé€ä¿¡ï¼ˆM5StickCæ¥ç¶šä¸­ãªã‚‰é€ã‚‹ï¼‰
        sendProgress(testProgress);

        if (testProgress >= 100000) {
          clearInterval(testTimer);
          testTimer = null;
        }
      }, 100);
    }
  });

  // ==================== BLE ====================
  $btnBle.addEventListener('click', async () => {
    try {
      $btnBle.textContent = 'æ¥ç¶šä¸­...';
      bleDevice = await navigator.bluetooth.requestDevice({
        filters: [{ name: 'OsampoMeter' }],
        optionalServices: [SERVICE_UUID]
      });
      bleDevice.addEventListener('gattserverdisconnected', onBleDisconnected);
      const server = await bleDevice.gatt.connect();
      const service = await server.getPrimaryService(SERVICE_UUID);
      bleCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
      $bleStatus.textContent = 'BLEæ¥ç¶šæ¸ˆã¿';
      $bleStatus.classList.add('connected');
      $btnBle.textContent = 'BLEæ¥ç¶šæ¸ˆã¿';
      $btnBle.disabled = true;
      updateStartButton();
    } catch (err) {
      console.error('BLEæ¥ç¶šã‚¨ãƒ©ãƒ¼:', err);
      $btnBle.textContent = 'BLEæ¥ç¶š';
      alert('BLEæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒ‡ãƒã‚¤ã‚¹ã®é›»æºã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
  });

  function onBleDisconnected() {
    bleCharacteristic = null;
    $bleStatus.textContent = 'BLEåˆ‡æ–­';
    $bleStatus.classList.remove('connected');
    $btnBle.textContent = 'BLEæ¥ç¶š';
    $btnBle.disabled = false;
    if (isRunning) stopTracking();
    updateStartButton();
  }

  async function sendProgress(value) {
    const clamped = Math.max(0, Math.min(100000, Math.round(value)));
    if (clamped === lastSentProgress) return;
    lastSentProgress = clamped;
    if (testMode || !bleCharacteristic) return;
    try {
      const buf = new ArrayBuffer(4);
      const view = new DataView(buf);
      view.setUint32(0, clamped, true);
      await bleCharacteristic.writeValueWithoutResponse(buf);
    } catch (err) {
      console.error('BLEé€ä¿¡ã‚¨ãƒ©ãƒ¼:', err);
    }
  }

  // ==================== GPSè¿½è·¡ ====================
  $btnStart.addEventListener('click', () => {
    if (isRunning) { stopTracking(); } else { startTracking(); }
  });

  function startTracking() {
    if (!destination) return;
    if (!testMode && !bleCharacteristic) return;

    isRunning = true;
    startDistance = null;
    lastSentProgress = -1;
    maxProgress = 0;
    $btnStart.textContent = 'ã‚¹ãƒˆãƒƒãƒ—';
    $btnStart.classList.remove('btn-start');
    $btnStart.classList.add('btn-stop');
    $progressValue.textContent = '0.000';
    $progressBar.style.width = '0%';
    $progressDistance.textContent = '';

    sendProgress(0);

    watchId = navigator.geolocation.watchPosition(
      onPositionUpdate, onPositionError,
      { enableHighAccuracy: true, maximumAge: 2000, timeout: 10000 }
    );
  }

  function stopTracking() {
    isRunning = false;
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    startDistance = null;
    maxProgress = 0;
    $btnStart.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
    $btnStart.classList.remove('btn-stop');
    $btnStart.classList.add('btn-start');
  }

  function onPositionUpdate(pos) {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
    if (currentMarker) {
      currentMarker.setCenter({ lat, lng });
    } else {
      currentMarker = new google.maps.Circle({
        map, center: { lat, lng },
        radius: 8, fillColor: '#3b82f6', fillOpacity: 1,
        strokeColor: '#fff', strokeWeight: 2, clickable: false
      });
    }

    const dist = haversineDistance(lat, lng, destination.lat, destination.lng);

    // å‡ºç™ºæ™‚ã®è·é›¢ã‚’è¨˜éŒ²
    if (startDistance === null) {
      startDistance = dist;
      if (startDistance < GOAL_RADIUS_M) {
        startDistance = GOAL_RADIUS_M;
      }
    }

    // é€²æ—è¨ˆç®—
    let progress;
    if (dist <= GOAL_RADIUS_M) {
      progress = 100000;
    } else {
      progress = (1 - dist / startDistance) * 100000;
      progress = Math.max(0, Math.min(99999, progress));
    }

    let progressRounded = Math.round(progress);

    // â˜… é€²æ—ã¯æ¸›ã‚‰ã•ãªã„ï¼ˆæœ€å¤§å€¤ã‚’ä¿æŒï¼‰
    if (progressRounded < maxProgress) {
      progressRounded = maxProgress;
    } else {
      maxProgress = progressRounded;
    }

    // UIæ›´æ–°
    const displayPct = (progressRounded / 1000).toFixed(3);
    $progressValue.textContent = displayPct;
    $progressBar.style.width = (progressRounded / 1000) + '%';

    // æ®‹ã‚Šè·é›¢ã‚’è¡¨ç¤º
    if (dist >= 1000) {
      $progressDistance.textContent = `æ®‹ã‚Š ${(dist / 1000).toFixed(1)} km`;
    } else {
      $progressDistance.textContent = `æ®‹ã‚Š ${Math.round(dist)} m`;
    }

    // BLEé€ä¿¡
    sendProgress(progressRounded);
  }

  function onPositionError(err) {
    console.error('GPS ã‚¨ãƒ©ãƒ¼:', err);
  }

  // ==================== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====================
  function haversineDistance(lat1, lng1, lat2, lng2) {
    const R = 6371000;
    const toRad = (deg) => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat / 2) ** 2 +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateStartButton() {
    const bleReady = testMode || bleCharacteristic;
    $btnStart.disabled = !(destination && bleReady);
  }
}

</script>
</body>
</html>
